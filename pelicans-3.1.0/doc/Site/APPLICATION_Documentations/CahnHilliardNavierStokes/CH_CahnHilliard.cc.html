<html>
<head>
<title>CH_CahnHilliard.cc</title>
<link rel=stylesheet type="text/css" href="stylesheet.css">
</head>
<body>
<pre>
<font class="comment">/*
 *  Copyright 1995-2010 by IRSN
 *
 *  This software is an application framework, with a set of integrated
 *  reusable components, whose purpose is to simplify the task of developing
 *  softwares of numerical mathematics and scientific computing.
 *
 *  This software is governed by the CeCILL-C license under French law and
 *  abiding by the rules of distribution of free software. You can use, modify
 *  and/or redistribute the software under the terms of the CeCILL-C license
 *  as circulated by CEA, CNRS and INRIA at the following URL
 *  &quot;http://www.cecill.info&quot;.
 *
 *  As a counterpart to the access to the source code and rights to copy,
 *  modify and redistribute granted by the license, users are provided only
 *  with a limited warranty and the software's author, the holder of the
 *  economic rights, and the successive licensors have only limited liability.
 *
 *  In this respect, the user's attention is drawn to the risks associated
 *  with loading, using, modifying and/or developing or reproducing the
 *  software by the user in light of its specific status of free software,
 *  that may mean that it is complicated to manipulate, and that also
 *  therefore means that it is reserved for developers and experienced
 *  professionals having in-depth computer knowledge. Users are therefore
 *  encouraged to load and test the software's suitability as regards their
 *  requirements in conditions enabling the security of their systems and/or
 *  data to be ensured and, more generally, to use and operate it in the same
 *  conditions as regards security.
 *
 *  The fact that you are presently reading this means that you have had
 *  knowledge of the CeCILL-C license and that you accept its terms.
 */
</font><font class="text">
</font><font class="kw2">#include</font><font class="text"> &lt;CH_CahnHilliard.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Communicator</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Error</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_MemoryTracer</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_ModuleExplorer</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Vector</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">LA_Matrix</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">LA_SeqMatrix</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">LA_SeqVector</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">LA_Solver</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_QRprovider</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_Point</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_Mpolyhedron</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_DiscreteField</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_DomainAndFields</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LocalEquation</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LocalFEcell</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_ResultSaver</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_SetOfDiscreteFields</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_SystemNumbering</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE_Parameter</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE_SetOfParameters</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE_TimeIterator</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;CH_BulkChemicalPotential.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;fstream&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;ios&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;iostream&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;iomanip&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;sstream&gt;

</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ; </font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">cout</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ios_base</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">setprecision</font><font class="text"> ; </font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">setw</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ostringstream</font><font class="text"> ;

</font><font class="kw3">PDE_LocalFE</font><font class="text">::field_id </font><font class="kw1">const</font><font class="text"> row = </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ;
</font><font class="kw3">PDE_LocalFE</font><font class="text">::field_id </font><font class="kw1">const</font><font class="text"> col = </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ;

</font><font class="kw1">struct</font><font class="text"> CH_CahnHilliard_ERROR
{
   </font><font class="kw1">static</font><font class="text"> </font><font class="kw1">void</font><font class="text"> n0( </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; fname ) ;
} ;

CH_CahnHilliard </font><font class="kw1">const</font><font class="text">*
CH_CahnHilliard::PROTOTYPE = </font><font class="kw1">new</font><font class="text"> CH_CahnHilliard() ;

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">CH_CahnHilliard:: CH_CahnHilliard( </font><font class="kw1">void</font><font class="text"> )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">   : </font><font class="kw3">FE_OneStepIterationOpen</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard&quot;</font><font class="text"> )
   , PRINTED_RES( 0 )
{
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">CH_CahnHilliard*
CH_CahnHilliard:: create_replica( </font><font class="kw3">PEL_Object</font><font class="text">* a_owner,
                                  </font><font class="kw3">PDE_DomainAndFields</font><font class="text"> </font><font class="kw1">const</font><font class="text">* dom,
                                  </font><font class="kw3">FE_SetOfParameters</font><font class="text"> </font><font class="kw1">const</font><font class="text">* prms,
                                  </font><font class="kw3">PEL_ModuleExplorer</font><font class="text">* exp ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: create_replica&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( create_replica_PRE( a_owner, dom, prms, exp ) ) ;

   CH_CahnHilliard* result =
                      </font><font class="kw1">new</font><font class="text"> CH_CahnHilliard( a_owner, dom, prms, exp ) ;

   </font><font class="kw3">PEL_CHECK</font><font class="text">( create_replica_POST( result, a_owner, dom, prms, exp ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">CH_CahnHilliard:: CH_CahnHilliard( </font><font class="kw3">PEL_Object</font><font class="text">* a_owner,
                                   </font><font class="kw3">PDE_DomainAndFields</font><font class="text"> </font><font class="kw1">const</font><font class="text">* dom,
                                   </font><font class="kw3">FE_SetOfParameters</font><font class="text"> </font><font class="kw1">const</font><font class="text">* prms,
                                   </font><font class="kw3">PEL_ModuleExplorer</font><font class="text"> </font><font class="kw1">const</font><font class="text">* exp )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">   : </font><font class="kw3">FE_OneStepIterationOpen</font><font class="text">( a_owner, dom, exp )
   , C1( dom-&gt;set_of_discrete_fields()-&gt;item(
                     exp-&gt;string_data( </font><font class="string">&quot;phase_field_1&quot;</font><font class="text"> ) ) )
   , C1_EXP( dom-&gt;set_of_discrete_fields()-&gt;item(
                     exp-&gt;string_data( </font><font class="string">&quot;phase_field_1_explicit&quot;</font><font class="text"> ) ) )
   , M1( dom-&gt;set_of_discrete_fields()-&gt;item(
                     exp-&gt;string_data( </font><font class="string">&quot;generalized_potential_1&quot;</font><font class="text"> ) ) )
   , C2( dom-&gt;set_of_discrete_fields()-&gt;item(
                     exp-&gt;string_data( </font><font class="string">&quot;phase_field_2&quot;</font><font class="text"> ) ) )
   , C2_EXP( dom-&gt;set_of_discrete_fields()-&gt;item(
                     exp-&gt;string_data( </font><font class="string">&quot;phase_field_2_explicit&quot;</font><font class="text"> ) ) )
   , M2( dom-&gt;set_of_discrete_fields()-&gt;item(
                     exp-&gt;string_data( </font><font class="string">&quot;generalized_potential_2&quot;</font><font class="text"> ) ) )
   , L_UPDATE( exp-&gt;int_data( </font><font class="string">&quot;level_to_update&quot;</font><font class="text"> ) )
   , L_EXPLICIT( exp-&gt;int_data( </font><font class="string">&quot;level_of_explicit&quot;</font><font class="text"> ) )
   , AA( 0 )
   , L_AA( </font><font class="kw3">PEL</font><font class="text">::bad_index() )
   , EPS( exp-&gt;double_data( </font><font class="string">&quot;thickness&quot;</font><font class="text"> ) )
   , CAP1( 0.0 )
   , CAP2( 0.0 )
   , THETA( 1.0 )
   , NB_PRE_EULER_STEP( 1 )</font><font class="comment">//valeur par defaut &#xE0; 0
</font><font class="text">   , MOB_CST( exp-&gt;double_data( </font><font class="string">&quot;mobility_cst&quot;</font><font class="text"> ) )
   , MOB_DEG( exp-&gt;double_data( </font><font class="string">&quot;mobility_deg&quot;</font><font class="text"> ) )
   , MOB_EXP( exp-&gt;bool_data( </font><font class="string">&quot;explicit_mobility&quot;</font><font class="text"> ) )
   , MOB_MOD( </font><font class="kw1">false</font><font class="text"> )
   , MOB_MAX( 0.1 )
   , ELEMENT_EQ( </font><font class="kw3">PDE_LocalEquation</font><font class="text">::create( </font><font class="kw1">this</font><font class="text"> ) )
   , QRP( </font><font class="kw3">GE_QRprovider</font><font class="text">::object(
                      exp-&gt;string_data( </font><font class="string">&quot;quadrature_rule_provider&quot;</font><font class="text"> ) ) )
   , cFE( dom-&gt;create_LocalFEcell( </font><font class="kw1">this</font><font class="text"> ) )
   , VOL1( </font><font class="kw3">PEL</font><font class="text">::bad_double() )
   , VOL2( </font><font class="kw3">PEL</font><font class="text">::bad_double() )
   , ITER( 1 )
   , NB_ITER_MAX( exp-&gt;int_data( </font><font class="string">&quot;nb_iterations_max&quot;</font><font class="text"> ) )
   , TOL( exp-&gt;double_data( </font><font class="string">&quot;newton_tolerance&quot;</font><font class="text"> ) )
   , idx_C1( 0 )
   , idx_M1( 1 )
   , idx_C2( 2 )
   , idx_M2( 3 )
   , LHS_cst( 0 )
   , LHS( 0 )
   , RHS( 0 )
   , UNK( 0 )
   , UNK_LOC( </font><font class="kw3">LA_SeqVector</font><font class="text">::create( </font><font class="kw1">this</font><font class="text">, 0 ) )
   , SOLVER( 0 )
   , PRINTED_RES( 4 )
{
   cFE-&gt;require_field_calculation( C1, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ;
   cFE-&gt;require_field_calculation( C1, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ;
   cFE-&gt;require_field_calculation( C1_EXP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ;
   cFE-&gt;require_field_calculation( C1_EXP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ;
   cFE-&gt;require_field_calculation( C2, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ;
   cFE-&gt;require_field_calculation( C2, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ;
   cFE-&gt;require_field_calculation( C2_EXP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ;
   cFE-&gt;require_field_calculation( C2_EXP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ;

   cFE-&gt;require_field_calculation( M1, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ;
   cFE-&gt;require_field_calculation( M1, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ;
   cFE-&gt;require_field_calculation( M2, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ;
   cFE-&gt;require_field_calculation( M2, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ;

   </font><font class="kw1">if</font><font class="text">( exp-&gt;has_module( </font><font class="string">&quot;advection&quot;</font><font class="text"> ) )
   {
      </font><font class="kw3">PEL_ModuleExplorer</font><font class="text">* e = exp-&gt;create_subexplorer( 0, </font><font class="string">&quot;advection&quot;</font><font class="text"> ) ;
      AA = dom-&gt;set_of_discrete_fields()-&gt;item( e-&gt;string_data( </font><font class="string">&quot;field&quot;</font><font class="text"> ) ) ;
      check_field_nb_components( AA, dom-&gt;nb_space_dimensions() ) ;
      L_AA = e-&gt;int_data( </font><font class="string">&quot;level&quot;</font><font class="text"> ) ;
      e-&gt;destroy() ;
      cFE-&gt;require_field_calculation( AA, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ;
   }

   </font><font class="kw3">PEL_ModuleExplorer</font><font class="text"> </font><font class="kw1">const</font><font class="text">* ee =
                      exp-&gt;create_subexplorer( 0, </font><font class="string">&quot;CH_BulkChemicalPotential&quot;</font><font class="text"> ) ;
   BULK_MU = CH_BulkChemicalPotential::create( </font><font class="kw1">this</font><font class="text">, ee ) ;
   ee-&gt;destroy() ; ee = 0 ;

   CAP1 = 3.*EPS*BULK_MU-&gt;Sigma1()/4. ;
   CAP2 = 3.*EPS*BULK_MU-&gt;Sigma2()/4. ;

   </font><font class="kw1">if</font><font class="text">( exp-&gt;has_entry( </font><font class="string">&quot;theta_coef&quot;</font><font class="text"> ) )
   {
      THETA = exp-&gt;double_data( </font><font class="string">&quot;theta_coef&quot;</font><font class="text">) ;
   }
   </font><font class="kw1">if</font><font class="text">( exp-&gt;has_entry( </font><font class="string">&quot;nb_pre_euler_step&quot;</font><font class="text"> ) )
   {
      NB_PRE_EULER_STEP = exp-&gt;int_data( </font><font class="string">&quot;nb_pre_euler_step&quot;</font><font class="text">) ;
   }
   </font><font class="kw1">if</font><font class="text">( exp-&gt;has_entry( </font><font class="string">&quot;mobility_modification&quot;</font><font class="text"> ) )
   {
      MOB_MOD = exp-&gt;bool_data( </font><font class="string">&quot;mobility_modification&quot;</font><font class="text">) ;
      </font><font class="kw1">if</font><font class="text">( exp-&gt;has_entry( </font><font class="string">&quot;mobility_max&quot;</font><font class="text"> ) )
         MOB_MAX =  exp-&gt;double_data( </font><font class="string">&quot;mobility_max&quot;</font><font class="text">) ;
      M1_EXP = dom-&gt;set_of_discrete_fields()-&gt;item(
                exp-&gt;string_data( </font><font class="string">&quot;generalized_potential_1_explicit&quot;</font><font class="text"> ) ) ;
      M2_EXP = dom-&gt;set_of_discrete_fields()-&gt;item(
                     exp-&gt;string_data( </font><font class="string">&quot;generalized_potential_2_explicit&quot;</font><font class="text"> ) ) ;
      cFE-&gt;require_field_calculation( M1_EXP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ;
      cFE-&gt;require_field_calculation( M2_EXP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ;
   }

   </font><font class="comment">// -- Global Equation
</font><font class="text">   </font><font class="kw3">PEL_Vector</font><font class="text">* vec = </font><font class="kw3">PEL_Vector</font><font class="text">::create( 0, 4 ) ;
   vec-&gt;set_at( idx_C1, </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text">::create( 0, C1, </font><font class="kw1">true</font><font class="text"> ) ) ;
   vec-&gt;set_at( idx_M1, </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text">::create( 0, M1, </font><font class="kw1">true</font><font class="text"> ) ) ;
   vec-&gt;set_at( idx_C2, </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text">::create( 0, C2, </font><font class="kw1">true</font><font class="text"> ) ) ;
   vec-&gt;set_at( idx_M2, </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text">::create( 0, M2, </font><font class="kw1">true</font><font class="text"> ) ) ;

   </font><font class="comment">//std::string ordering = &quot;sequence_of_the_unknowns&quot; ;
</font><font class="text">   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> ordering = </font><font class="string">&quot;sequence_of_the_discrete_fields&quot;</font><font class="text"> ;
   NMB = </font><font class="kw3">PDE_SystemNumbering</font><font class="text">::create( </font><font class="kw1">this</font><font class="text">, vec, ordering ) ;

   ee = exp-&gt;create_subexplorer( 0, </font><font class="string">&quot;LA_Matrix&quot;</font><font class="text"> ) ;
   LHS = </font><font class="kw3">LA_Matrix</font><font class="text">::make( </font><font class="kw1">this</font><font class="text">, ee ) ;
   ee-&gt;destroy() ; ee = 0 ;

   LHS_cst = LHS-&gt;create_matrix( </font><font class="kw1">this</font><font class="text"> ) ;
   RHS = LHS-&gt;create_vector( </font><font class="kw1">this</font><font class="text"> ) ;
   UNK = LHS-&gt;create_vector( </font><font class="kw1">this</font><font class="text"> ) ;
   
   ee = exp-&gt;create_subexplorer( 0, </font><font class="string">&quot;LA_Solver&quot;</font><font class="text"> ) ;
   SOLVER = </font><font class="kw3">LA_Solver</font><font class="text">::make( </font><font class="kw1">this</font><font class="text">, ee ) ;
   ee-&gt;destroy() ; ee = 0 ;

   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> nn = </font><font class="string">&quot;multilevel_preconditioner_name&quot;</font><font class="text"> ;
   configure_multilevel_preconditioner( exp, nn, dom, NMB ) ;
   vec-&gt;destroy() ; vec = 0 ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">CH_CahnHilliard:: ~CH_CahnHilliard( </font><font class="kw1">void</font><font class="text"> )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw2">size_t
</font><font class="text">CH_CahnHilliard:: nb_unknowns( </font><font class="kw1">void</font><font class="text"> ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: nb_unknowns&quot;</font><font class="text"> ) ;

   </font><font class="kw2">size_t</font><font class="text"> result = 4 ;

   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">PDE_DiscreteField</font><font class="text">*
CH_CahnHilliard:: field( </font><font class="kw2">size_t</font><font class="text"> i_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: field&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( field_PRE( i_unk ) ) ;

   </font><font class="kw3">PDE_DiscreteField</font><font class="text">* result = 0 ;
   </font><font class="kw1">if</font><font class="text">( i_unk == idx_C1 ) result = C1 ;
   </font><font class="kw1">if</font><font class="text">( i_unk == idx_M1 ) result = M1 ;
   </font><font class="kw1">if</font><font class="text">( i_unk == idx_C2 ) result = C2 ;
   </font><font class="kw1">if</font><font class="text">( i_unk == idx_M2 ) result = M2 ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( field_POST( result , i_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw2">size_t
</font><font class="text">CH_CahnHilliard:: level_of_field( </font><font class="kw2">size_t</font><font class="text"> i_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: level_of_field&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( level_of_field_PRE( i_unk ) ) ;

   </font><font class="kw2">size_t</font><font class="text"> result = L_UPDATE ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( level_of_field_POST( result, i_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text"> </font><font class="kw1">const</font><font class="text">*
CH_CahnHilliard:: link_DOF_2_unknown( </font><font class="kw2">size_t</font><font class="text"> i_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: link_DOF_2_unknown&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( link_DOF_2_unknown_PRE( i_unk ) ) ;

   </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text"> </font><font class="kw1">const</font><font class="text">* result = NMB-&gt;link( i_unk ) ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( link_DOF_2_unknown_POST( result, i_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: build_function_and_jacobian( </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it)
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: build_function_and_jacobian&quot;</font><font class="text"> ) ;

   start_assembling_timer() ;

   </font><font class="kw1">if</font><font class="text">( ITER == 1 )
   {
      NMB-&gt;reset() ;

      </font><font class="kw2">size_t</font><font class="text"> nb_global_unk = NMB-&gt;nb_global_unknowns() ;
      </font><font class="kw2">size_t</font><font class="text"> nb_local_unk  = NMB-&gt;nb_unknowns_on_current_process() ;

      LHS-&gt;re_initialize( nb_global_unk, nb_global_unk,
                          nb_local_unk, nb_local_unk ) ;
      LHS_cst-&gt;re_initialize( nb_global_unk, nb_global_unk,
                              nb_local_unk, nb_local_unk ) ;
      RHS-&gt;re_initialize( nb_global_unk, nb_local_unk ) ;
      UNK-&gt;re_initialize( nb_global_unk, nb_local_unk ) ;

      NMB-&gt;define_scatters( UNK ) ;

      </font><font class="kw2">size_t</font><font class="text"> nn = NMB-&gt;link( 0 )-&gt;unknown_vector_size() ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=1 ; i&lt;NMB-&gt;nb_links() ; ++i )
      {
         </font><font class="kw2">size_t</font><font class="text"> mm = NMB-&gt;link( i )-&gt;unknown_vector_size() ;
         </font><font class="kw1">if</font><font class="text">( mm &gt; nn ) nn = mm ;
      }
      UNK_LOC-&gt;re_initialize( nn ) ;
   }
   </font><font class="kw1">else
</font><font class="text">   {
      LHS-&gt;nullify() ;
      RHS-&gt;nullify() ;
   }

   loop_on_cells( t_it ) ;

   LHS-&gt;synchronize() ;
   </font><font class="kw1">if</font><font class="text">( !LHS_cst-&gt;is_synchronized() ) LHS_cst-&gt;synchronize() ;
   LHS-&gt;add_Mat( LHS_cst ) ;

   RHS-&gt;synchronize() ;

   stop_assembling_timer() ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">LA_SeqVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">*
CH_CahnHilliard:: create_function( </font><font class="kw3">PEL_Object</font><font class="text">* a_owner, </font><font class="kw2">size_t</font><font class="text"> i_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: create_function&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( create_function_PRE( a_owner, i_unk ) ) ;

   </font><font class="kw2">size_t</font><font class="text"> nn = NMB-&gt;link( i_unk )-&gt;unknown_vector_size() ;
   </font><font class="kw3">LA_SeqVector</font><font class="text">* result = </font><font class="kw3">LA_SeqVector</font><font class="text">::create( a_owner, nn ) ;
   NMB-&gt;scatter( i_unk )-&gt;get( RHS, result ) ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( create_function_POST( result, a_owner, i_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">LA_SeqMatrix</font><font class="text"> </font><font class="kw1">const</font><font class="text">*
CH_CahnHilliard:: create_jacobian( </font><font class="kw3">PEL_Object</font><font class="text">* a_owner,
                                   </font><font class="kw2">size_t</font><font class="text"> i_eq, </font><font class="kw2">size_t</font><font class="text"> j_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: create_jacobian&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( create_jacobian_PRE( a_owner, i_eq, j_unk ) ) ;

   </font><font class="kw3">LA_SeqMatrix</font><font class="text"> </font><font class="kw1">const</font><font class="text">* result =
                </font><font class="kw3">PDE</font><font class="text">::create_extracted_block( a_owner, LHS, NMB, i_eq, j_unk ) ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( create_jacobian_POST( result, a_owner, i_eq,  j_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: do_one_inner_iteration( </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: do_one_inner_iteration&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( do_one_inner_iteration_PRE( t_it ) ) ;

   start_total_timer( </font><font class="string">&quot;CH_CahnHilliard:: do_one_inner_iteration&quot;</font><font class="text"> ) ;

   ITER = 0 ;
   VOL1 = 0.0 ;
   VOL2 = 0.0 ;
   </font><font class="kw1">do
</font><font class="text">   {
      ITER++ ;
      </font><font class="kw1">if</font><font class="text">( ITER &gt;= NB_ITER_MAX )
         </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain( </font><font class="string">&quot;Newton convergence failure&quot;</font><font class="text"> ) ;

      build_function_and_jacobian( t_it ) ;

      start_solving_timer() ;

      SOLVER-&gt;set_stop_on_error( </font><font class="kw1">false</font><font class="text"> ) ;

      </font><font class="kw1">if</font><font class="text">( ( verbose_level() &gt;= 1 ) &amp;&amp; ( ITER == 1 ) )
      {
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; indent() &lt;&lt; </font><font class="string">&quot;   nb unknowns: &quot;
</font><font class="text">                                &lt;&lt; UNK-&gt;nb_rows() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; indent() &lt;&lt; </font><font class="string">&quot;   nb stored items: &quot;
</font><font class="text">                                &lt;&lt; LHS-&gt;nb_stored_items() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; indent() &lt;&lt; </font><font class="string">&quot;   set_matrix: &quot;</font><font class="text"> ;
         </font><font class="kw3">PEL_MemoryTracer</font><font class="text">::display_memory( </font><font class="kw3">PEL</font><font class="text">::out(),
                                           </font><font class="kw3">PEL_MemoryTracer</font><font class="text">::used_memory() ) ;
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="string">&quot; -&gt; &quot;</font><font class="text"> ;
      }
      </font><font class="comment">//??? voir AP_NavierStokes2CFV
</font><font class="text">      SOLVER-&gt;set_matrix( LHS ) ;
      </font><font class="kw1">if</font><font class="text">( ( verbose_level() &gt;= 1 ) &amp;&amp; ( ITER == 1 ) )
      {
         </font><font class="kw3">PEL_MemoryTracer</font><font class="text">::display_memory( </font><font class="kw3">PEL</font><font class="text">::out(),
                                           </font><font class="kw3">PEL_MemoryTracer</font><font class="text">::used_memory() ) ;
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
      }
      SOLVER-&gt;solve( RHS, UNK ) ;
      </font><font class="kw1">if</font><font class="text">( !SOLVER-&gt;solution_is_achieved() )
      {
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="string">&quot;writing rhs in vec.mtx&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         RHS-&gt;write( </font><font class="string">&quot;vec.mtx&quot;</font><font class="text"> ) ;
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="string">&quot;writing lhs in mat.mtx&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         LHS-&gt;writeMM( </font><font class="string">&quot;mat.mtx&quot;</font><font class="text"> ) ;
         </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain(
            </font><font class="string">&quot;*** CH_CahnHilliard:\n&quot;
</font><font class="text">            </font><font class="string">&quot;    Linear system resolution failure&quot;</font><font class="text"> ) ;
      }

      </font><font class="comment">//??? on devrait pouvoir conserver le profil, qui ne change
</font><font class="text">      </font><font class="comment">//??? pas d'une iteration de Newton &#xE0; l'autre
</font><font class="text">      SOLVER-&gt;unset_matrix() ;

      stop_solving_timer() ;

      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;NMB-&gt;nb_links() ; ++i )
      {
         </font><font class="kw3">LA_Scatter</font><font class="text"> </font><font class="kw1">const</font><font class="text">* sca = NMB-&gt;scatter( i ) ;
         </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text"> </font><font class="kw1">const</font><font class="text">* link = NMB-&gt;link( i ) ;
         </font><font class="kw3">PEL_ASSERT</font><font class="text">( field( i ) == link-&gt;field() ) ;
         sca-&gt;get( UNK, UNK_LOC ) ;
         field( i )-&gt;add_to_free_DOFs_value( L_UPDATE, UNK_LOC, link, 1.0 ) ;

         </font><font class="kw1">if</font><font class="text">( verbose_level() &gt;= 1 )
         {
            PRINTED_RES( i ) = UNK_LOC-&gt;max_norm() ;
         }
      }

   } </font><font class="kw1">while</font><font class="text">( !convergence_achieved() ) ;

   </font><font class="comment">// memory release
</font><font class="text">   LHS-&gt;re_initialize( 0, 0, 0, 0 ) ;
   LHS_cst-&gt;re_initialize( 0, 0, 0, 0 ) ;
   RHS-&gt;re_initialize( 0, 0 ) ;
   UNK-&gt;re_initialize( 0, 0 ) ;

   stop_total_timer() ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: save_other_than_time_and_fields(
                                                 </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it,
                                                 </font><font class="kw3">PDE_ResultSaver</font><font class="text">* rs )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: save_other_than_time_and_fields&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( save_other_than_time_and_fields_PRE( t_it, rs ) ) ;
   </font><font class="kw3">PEL_CHECK_INV</font><font class="text">( invariant() ) ;

   </font><font class="kw3">PEL_Communicator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* com = communicator() ;

   </font><font class="kw1">if</font><font class="text">( VOL1 == </font><font class="kw3">PEL</font><font class="text">::bad_double() )
   {
      </font><font class="kw3">PEL_ASSERT</font><font class="text">( VOL2 == </font><font class="kw3">PEL</font><font class="text">::bad_double() ) ;

      </font><font class="kw1">if</font><font class="text">( com-&gt;rank() == 0 )
      {
         </font><font class="kw2">std</font><font class="text">::ofstream ofs( </font><font class="string">&quot;volumes.txt&quot;</font><font class="text">, </font><font class="kw2">std</font><font class="text">::ios::out | </font><font class="kw2">std</font><font class="text">::ios::trunc ) ;
         </font><font class="kw1">if</font><font class="text">( !ofs ) CH_CahnHilliard_ERROR::n0( </font><font class="string">&quot;volumes.txt&quot;</font><font class="text"> ) ;
         ofs &lt;&lt; </font><font class="string">&quot;#&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="string">&quot;# CH_CahnHilliard generated file&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="string">&quot;# meaning of the columns:&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="string">&quot;#    TIME : current time&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="string">&quot;#    VOL1 : explicit volume of phase 1&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="string">&quot;#    VOL2 : explicit volume of phase 2&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="string">&quot;#&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="string">&quot;#       TIME         VOL1         VOL2&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
         ofs.close() ;
      }
   }
   </font><font class="kw1">else
</font><font class="text">   {
      VOL1 = com-&gt;sum( VOL1 ) ;
      VOL2 = com-&gt;sum( VOL2 ) ;

      </font><font class="kw1">if</font><font class="text">( com-&gt;rank() == 0 )
      {
         </font><font class="kw2">std</font><font class="text">::ofstream ofs( </font><font class="string">&quot;volumes.txt&quot;</font><font class="text">, </font><font class="kw2">std</font><font class="text">::ios::out | </font><font class="kw2">std</font><font class="text">::ios::app ) ;
         ofs.setf( </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ios_base</font><font class="text">::</font><font class="kw2">uppercase</font><font class="text"> | </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ios_base</font><font class="text">::</font><font class="kw2">scientific</font><font class="text"> ) ;
         ofs &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">setprecision</font><font class="text">( 5 ) ;

         ofs &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 ) &lt;&lt; t_it-&gt;time() &lt;&lt; </font><font class="string">&quot; &quot;</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 ) &lt;&lt; VOL1 &lt;&lt; </font><font class="string">&quot; &quot;</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 ) &lt;&lt; VOL2 &lt;&lt; </font><font class="string">&quot; &quot;</font><font class="text"> ;
         ofs &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;

         ofs.close() ;
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">bool
</font><font class="text">CH_CahnHilliard:: convergence_achieved( </font><font class="kw1">void</font><font class="text"> ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: convergence_achieved&quot;</font><font class="text"> ) ;

   </font><font class="kw1">double</font><font class="text"> rhs = RHS-&gt;two_norm() ;
   </font><font class="kw1">bool</font><font class="text"> result =  ( rhs &lt; TOL )  ;

   </font><font class="kw1">if</font><font class="text">( verbose_level() &gt;=1 )
   {
      </font><font class="kw2">ios_base</font><font class="text">::</font><font class="kw2">fmtflags</font><font class="text"> original_flags = </font><font class="kw3">PEL</font><font class="text">::out().</font><font class="kw2">flags</font><font class="text">() ;
      </font><font class="kw3">PEL</font><font class="text">::out().setf( </font><font class="kw2">ios_base</font><font class="text">::</font><font class="kw2">uppercase</font><font class="text"> | </font><font class="kw2">ios_base</font><font class="text">::</font><font class="kw2">scientific</font><font class="text"> ) ;
      </font><font class="kw1">bool</font><font class="text"> iterative = SOLVER-&gt;is_iterative() ;

      </font><font class="kw1">if</font><font class="text">( ITER==1 )
      {
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; indent()
                    &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 3+12 ) &lt;&lt; </font><font class="string">&quot;max(d_C1)&quot;
</font><font class="text">                    &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )   &lt;&lt; </font><font class="string">&quot;max(d_M1)&quot;
</font><font class="text">                    &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )   &lt;&lt; </font><font class="string">&quot;max(d_C2)&quot;
</font><font class="text">                    &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )   &lt;&lt; </font><font class="string">&quot;max(d_M2)&quot;
</font><font class="text">                    &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )   &lt;&lt; </font><font class="string">&quot;L2(rhs)&quot;</font><font class="text"> ;
         </font><font class="kw1">if</font><font class="text">( iterative )
            </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 6 ) &lt;&lt; </font><font class="string">&quot;its&quot;</font><font class="text"> ;
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
      }

      </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; indent()
                 &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 3 ) &lt;&lt; ITER
                 &lt;&lt; </font><font class="kw2">setprecision</font><font class="text">( 3 ) &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )
                 &lt;&lt; PRINTED_RES( idx_C1 )
                 &lt;&lt; </font><font class="kw2">setprecision</font><font class="text">( 3 ) &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )
                 &lt;&lt; PRINTED_RES( idx_M1 )
                 &lt;&lt; </font><font class="kw2">setprecision</font><font class="text">( 3 ) &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )
                 &lt;&lt; PRINTED_RES( idx_C2 )
                 &lt;&lt; </font><font class="kw2">setprecision</font><font class="text">( 3 ) &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )
                 &lt;&lt; PRINTED_RES( idx_M2 )
                 &lt;&lt; </font><font class="kw2">setprecision</font><font class="text">( 3 ) &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 12 )
                 &lt;&lt; rhs ;
      </font><font class="kw1">if</font><font class="text">( iterative )
      {
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 6 ) &lt;&lt; SOLVER-&gt;nb_iterations_achieved() ;
      }
      </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
      </font><font class="kw3">PEL</font><font class="text">::out().</font><font class="kw2">flags</font><font class="text">( original_flags ) ;
   }

   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: loop_on_cells( </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: loop_on_cells&quot;</font><font class="text"> ) ;
   </font><font class="kw1">double</font><font class="text"> dt = t_it-&gt;time_step()  ;

   </font><font class="kw1">double</font><font class="text"> theta = ( t_it-&gt;iteration_number() &lt; NB_PRE_EULER_STEP+1 ? 1.0
                                                                   : THETA ) ;

   </font><font class="kw1">for</font><font class="text">( cFE-&gt;start() ; cFE-&gt;is_valid() ; cFE-&gt;go_next() )
   {
      cFE-&gt;set_row_and_col_fields( M1, C1 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         loop_Mi_Ci( C1, C1_EXP, M1, VOL1, dt ) ;
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_M1 ) ;
      </font><font class="kw1">if</font><font class="text">( ITER == 1 )
         </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS_cst, ELEMENT_EQ, NMB, idx_M1, idx_C1 ) ;

      cFE-&gt;set_row_and_col_fields( M1, M1 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         </font><font class="kw1">if</font><font class="text">( !MOB_MOD )
         {
            loop_Mi_Mi( M1, BULK_MU-&gt;Sigma1() ) ;
         }
         </font><font class="kw1">else
</font><font class="text">         {
            loop_Mi_Mi_MobMod( M1, M1_EXP, BULK_MU-&gt;Sigma1() ) ;
         }
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_M1 ) ;
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS, ELEMENT_EQ, NMB, idx_M1, idx_M1 ) ;

      cFE-&gt;set_row_and_col_fields( C1, M1 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         loop_Ci_Mi( M1 ) ;
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_C1 ) ;
      </font><font class="kw1">if</font><font class="text">( ITER == 1 )
         </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS_cst, ELEMENT_EQ, NMB, idx_C1, idx_M1 ) ;

      cFE-&gt;set_row_and_col_fields( C1, C1 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         loop_Ci_Ci( 1, CAP1, theta ) ;
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_C1 ) ;
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS, ELEMENT_EQ, NMB, idx_C1, idx_C1 ) ;

      cFE-&gt;set_row_and_col_fields( M2, C2 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         loop_Mi_Ci( C2, C2_EXP, M2, VOL2, dt ) ;
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_M2 ) ;
      </font><font class="kw1">if</font><font class="text">( ITER == 1 )
         </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS_cst, ELEMENT_EQ, NMB, idx_M2, idx_C2 ) ;

      cFE-&gt;set_row_and_col_fields( M2, M2 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         </font><font class="kw1">if</font><font class="text">( !MOB_MOD )
         {
            loop_Mi_Mi( M2, BULK_MU-&gt;Sigma2() ) ;
         }
         </font><font class="kw1">else
</font><font class="text">         {
            loop_Mi_Mi_MobMod( M2, M2_EXP, BULK_MU-&gt;Sigma2() ) ;
         }
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_M2 ) ;
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS, ELEMENT_EQ, NMB, idx_M2, idx_M2 ) ;

      cFE-&gt;set_row_and_col_fields( C2, M2 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         loop_Ci_Mi( M2 ) ;
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_C2 ) ;
      </font><font class="kw1">if</font><font class="text">( ITER == 1 )
         </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS_cst, ELEMENT_EQ, NMB, idx_C2, idx_M2 ) ;

      cFE-&gt;set_row_and_col_fields( C2, C2 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         loop_Ci_Ci( 2, CAP2, theta ) ;
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_C2 ) ;
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS, ELEMENT_EQ, NMB, idx_C2, idx_C2 ) ;

      cFE-&gt;set_row_and_col_fields( C1, C2 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         loop_Ci_Cj( 1, 2 ) ;
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_C1 ) ;
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS, ELEMENT_EQ, NMB, idx_C1, idx_C2 ) ;

      cFE-&gt;set_row_and_col_fields( C2, C1 ) ;
</font><font class="comment">//    ------------------------------------
</font><font class="text">      ELEMENT_EQ-&gt;initialize( cFE-&gt;row_field_node_connectivity(), 1,
                              cFE-&gt;col_field_node_connectivity(), 1 ) ;
      cFE-&gt;start_IP_iterator( QRP ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         loop_Ci_Cj( 2, 1 ) ;
      }
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_vector_1( RHS, ELEMENT_EQ, NMB, idx_C2 ) ;
      </font><font class="kw3">PDE</font><font class="text">::assemble_in_matrix_0( LHS, ELEMENT_EQ, NMB, idx_C2, idx_C1 ) ;
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: loop_Mi_Ci( </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* ci,
                              </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* ci_exp,
                              </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* mi,
                              </font><font class="kw1">double</font><font class="text">&amp; vol,
                              </font><font class="kw1">double</font><font class="text"> dt )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: loop_Mi_Ci&quot;</font><font class="text"> ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_dims = cFE-&gt;nb_space_dimensions() ;
   </font><font class="kw3">doubleVector</font><font class="text"> vv( nb_dims ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> cv( nb_dims ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> aa( nb_dims ) ;

   </font><font class="kw1">double</font><font class="text"> val_exp = cFE-&gt;value_at_IP( ci_exp, L_EXPLICIT ) ;
   </font><font class="kw1">double</font><font class="text"> xx = ( cFE-&gt;value_at_IP( ci, L_UPDATE ) - val_exp ) / dt ;
   </font><font class="kw1">if</font><font class="text">( AA != 0 )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         vv( d ) = cFE-&gt;value_at_IP( AA, L_AA, d ) ;
         xx += vv( d ) * cFE-&gt;gradient_at_IP( ci, L_UPDATE, d ) ;
      }
   }
   </font><font class="kw3">FE</font><font class="text">::add_row( ELEMENT_EQ, cFE, -xx ) ;

   </font><font class="kw1">if</font><font class="text">( ITER==1 )
   {
      </font><font class="kw3">FE</font><font class="text">::add_row_col_NS( ELEMENT_EQ, cFE, 1.0/dt ) ;
      </font><font class="kw1">if</font><font class="text">( AA != 0 )
      {
         </font><font class="kw3">FE</font><font class="text">::add_row_vvgrad_col( ELEMENT_EQ, cFE, vv, 1.0 ) ;
      }

      </font><font class="kw1">double</font><font class="text"> ww = cFE-&gt;weight_of_IP() ;
      </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
      {
         ww *= 2.0 * </font><font class="kw3">PEL</font><font class="text">::pi() * cFE-&gt;coordinates_of_IP()-&gt;coordinate( 0 ) ;
      }
      vol += val_exp * ww ;
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: loop_Mi_Mi( </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* mi,
                              </font><font class="kw1">double</font><font class="text"> sigma )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: loop_Mi_Mi&quot;</font><font class="text"> ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = cFE-&gt;nb_space_dimensions() ;
   </font><font class="kw3">doubleVector</font><font class="text"> vv( nb_dims ) ;

   </font><font class="kw1">double</font><font class="text"> x = 0.0 ;
   </font><font class="kw1">double</font><font class="text"> y = 0.0 ;
   </font><font class="kw1">if</font><font class="text">( MOB_EXP )
   {
      x =  cFE-&gt;value_at_IP( C1_EXP, L_EXPLICIT ) ;
      y =  cFE-&gt;value_at_IP( C2_EXP, L_EXPLICIT ) ;
   }
   </font><font class="kw1">else
</font><font class="text">   {
      x =  cFE-&gt;value_at_IP( C1, L_UPDATE ) ;
      y =  cFE-&gt;value_at_IP( C2, L_UPDATE ) ;
   }
   </font><font class="kw1">double</font><font class="text"> g = (1.-x)*(1.-x)*(1.-y)*(1.-y)*(x+y)*(x+y) ;

   </font><font class="kw1">double</font><font class="text"> mo = (MOB_CST + MOB_DEG * g )/sigma ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
   {
      vv( d ) = - mo * cFE-&gt;gradient_at_IP( mi, L_UPDATE, d ) ;
   }
   </font><font class="kw3">FE</font><font class="text">::add_grad_row( ELEMENT_EQ, cFE, vv ) ;

   </font><font class="comment">//????? on devrait pouvoir utiliser la version _S : ce sont
</font><font class="text">   </font><font class="comment">//????? des champs diff&#xE9;rents, mais avec la meme discretisation
</font><font class="text">   </font><font class="comment">//
</font><font class="text">   </font><font class="comment">//????? si on n'est pas &#xE0; l'it&#xE9;ration 1 et MOX_EXP ???
</font><font class="text">   </font><font class="kw3">FE</font><font class="text">::add_grad_row_grad_col_NS( ELEMENT_EQ, cFE, mo ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: loop_Mi_Mi_MobMod( </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* mi,
                                   </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* mi_exp,
                                   </font><font class="kw1">double</font><font class="text"> sigma )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: loop_Mi_Mi_MobMod&quot;</font><font class="text"> ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = cFE-&gt;nb_space_dimensions() ;
   </font><font class="kw3">doubleVector</font><font class="text"> vv( nb_dims ) ;

   </font><font class="kw1">double</font><font class="text"> x = 0.0 ;
   </font><font class="kw1">double</font><font class="text"> y = 0.0 ;
   </font><font class="kw1">if</font><font class="text">( MOB_EXP )
   {
      x =  cFE-&gt;value_at_IP( C1_EXP, L_EXPLICIT ) ;
      y =  cFE-&gt;value_at_IP( C2_EXP, L_EXPLICIT ) ;
   }
   </font><font class="kw1">else
</font><font class="text">   {
      x =  cFE-&gt;value_at_IP( C1, L_UPDATE ) ;
      y =  cFE-&gt;value_at_IP( C2, L_UPDATE ) ;
   }
   </font><font class="kw1">double</font><font class="text"> g = (1.-x)*(1.-x)*(1.-y)*(1.-y)*(x+y)*(x+y) ;

   </font><font class="kw1">double</font><font class="text"> mo = ( MOB_CST + MOB_DEG * g )/sigma ;
   </font><font class="kw1">double</font><font class="text"> moc = ( MOB_CST + MOB_DEG * MOB_MAX )/sigma ;

   </font><font class="kw3">PEL_ASSERT</font><font class="text">( moc - mo &gt; 0 ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
   {
      vv( d ) = - moc * cFE-&gt;gradient_at_IP( mi, L_UPDATE, d )
                + ( moc - mo ) * cFE-&gt;gradient_at_IP( mi_exp, L_UPDATE, d );
   }
   </font><font class="kw3">FE</font><font class="text">::add_grad_row( ELEMENT_EQ, cFE, vv ) ;

   </font><font class="comment">//????? on devrait pouvoir utiliser la version _S : ce sont
</font><font class="text">   </font><font class="comment">//????? des champs diff&#xE9;rents, mais avec la meme discretisation
</font><font class="text">   </font><font class="comment">//
</font><font class="text">   </font><font class="comment">//????? si on n'est pas &#xE0; l'it&#xE9;ration 1 et MOX_EXP ???
</font><font class="text">   </font><font class="kw3">FE</font><font class="text">::add_grad_row_grad_col_NS( ELEMENT_EQ, cFE, moc ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: loop_Ci_Ci( </font><font class="kw2">size_t</font><font class="text"> i, </font><font class="kw1">double</font><font class="text"> cap, </font><font class="kw1">double</font><font class="text"> theta )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: loop_Ci_Ci&quot;</font><font class="text"> ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_dims = cFE-&gt;nb_space_dimensions() ;
   </font><font class="kw3">doubleVector</font><font class="text"> vv( nb_dims ) ;

   </font><font class="kw1">double</font><font class="text"> x = cFE-&gt;value_at_IP( C1, L_UPDATE ) ;
   </font><font class="kw1">double</font><font class="text"> y = cFE-&gt;value_at_IP( C2, L_UPDATE ) ;
   </font><font class="kw1">double</font><font class="text"> s = cFE-&gt;value_at_IP( C1_EXP, L_EXPLICIT ) ;
   </font><font class="kw1">double</font><font class="text"> t = cFE-&gt;value_at_IP( C2_EXP, L_EXPLICIT ) ;

   </font><font class="kw1">double</font><font class="text"> dF = BULK_MU-&gt;DDiF( x, y, s, t, i, EPS ) ;

   </font><font class="kw3">FE</font><font class="text">::add_row( ELEMENT_EQ, cFE, dF ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
   {
      </font><font class="kw1">if</font><font class="text">( i==1 )
      {
         vv( d ) = theta * cap * cFE-&gt;gradient_at_IP( C1, L_UPDATE, d ) ;
         </font><font class="kw1">if</font><font class="text">( theta != 1.0 )
         {
            vv( d ) += ( 1.0 - theta ) * cap *
                       cFE-&gt;gradient_at_IP( C1_EXP, L_EXPLICIT, d ) ;
         }
      }
      </font><font class="kw1">else</font><font class="text"> </font><font class="kw1">if</font><font class="text">( i==2 )
      {
         vv( d ) =  theta * cap * cFE-&gt;gradient_at_IP( C2, L_UPDATE, d ) ;
         </font><font class="kw1">if</font><font class="text">( theta != 1.0 )
         {
            vv( d ) += ( 1.0 - theta ) * cap *
                       cFE-&gt;gradient_at_IP( C2_EXP, L_EXPLICIT, d ) ;
         }
      }
   }
   </font><font class="kw3">FE</font><font class="text">::add_grad_row( ELEMENT_EQ, cFE, vv ) ;

   </font><font class="kw3">FE</font><font class="text">::add_grad_row_grad_col_NS( ELEMENT_EQ, cFE, -cap*theta ) ;

   </font><font class="kw1">double</font><font class="text"> d2F = BULK_MU-&gt;dj_DDiF( x, y, s, t, i, i, EPS ) ;

   </font><font class="kw3">FE</font><font class="text">::add_row_col_NS( ELEMENT_EQ, cFE, -d2F ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: loop_Ci_Cj( </font><font class="kw2">size_t</font><font class="text"> i, </font><font class="kw2">size_t</font><font class="text"> j )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: loop_Ci_Cj&quot;</font><font class="text"> ) ;

   </font><font class="kw1">double</font><font class="text"> x = cFE-&gt;value_at_IP( C1, L_UPDATE ) ;
   </font><font class="kw1">double</font><font class="text"> y = cFE-&gt;value_at_IP( C2, L_UPDATE ) ;

   </font><font class="kw1">double</font><font class="text"> s = cFE-&gt;value_at_IP( C1_EXP, L_EXPLICIT ) ;
   </font><font class="kw1">double</font><font class="text"> t = cFE-&gt;value_at_IP( C2_EXP, L_EXPLICIT ) ;

   </font><font class="kw1">double</font><font class="text"> d2F = BULK_MU-&gt;dj_DDiF( x, y, s, t, i, j, EPS );

   </font><font class="kw3">FE</font><font class="text">::add_row_col_NS( ELEMENT_EQ, cFE, -d2F ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: loop_Ci_Mi( </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* mi )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: loop_Ci_Mi&quot;</font><font class="text"> ) ;

   </font><font class="kw3">FE</font><font class="text">::add_row( ELEMENT_EQ, cFE, -cFE-&gt;value_at_IP( mi, L_UPDATE ) ) ;
   </font><font class="kw1">if</font><font class="text">( ITER==1 ) </font><font class="kw3">FE</font><font class="text">::add_row_col_NS( ELEMENT_EQ, cFE, 1.0 ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard:: print( </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ostream</font><font class="text">&amp; os, </font><font class="kw2">size_t</font><font class="text"> indent_width ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;CH_CahnHilliard:: print&quot;</font><font class="text"> ) ;

   </font><font class="kw3">FE_OneStepIteration</font><font class="text">:: print( os, indent_width ) ;

   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> </font><font class="kw1">const</font><font class="text"> s( indent_width+3, </font><font class="string">' '</font><font class="text"> ) ;

   os &lt;&lt; s &lt;&lt; </font><font class="string">&quot;Mobility: &quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   os &lt;&lt; s &lt;&lt; </font><font class="string">&quot;  explicit: &quot;</font><font class="text"> ;
   </font><font class="kw1">if</font><font class="text">( MOB_EXP )
   {
      os &lt;&lt; </font><font class="string">&quot;yes&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   }
   </font><font class="kw1">else
</font><font class="text">   {
      os &lt;&lt; </font><font class="string">&quot;no&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   }
   os &lt;&lt; s &lt;&lt; </font><font class="string">&quot;  constant   part: &quot;</font><font class="text"> &lt;&lt; MOB_CST &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   os &lt;&lt; s &lt;&lt; </font><font class="string">&quot;  degenerate part: &quot;</font><font class="text"> &lt;&lt; MOB_DEG &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   os &lt;&lt; s &lt;&lt; </font><font class="string">&quot;  discretization trick: &quot;</font><font class="text"> ;
   </font><font class="kw1">if</font><font class="text">( MOB_MOD )
   {
      os &lt;&lt; </font><font class="string">&quot;yes&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   }
   </font><font class="kw1">else
</font><font class="text">   {
      os &lt;&lt; </font><font class="string">&quot;no&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   }
}

</font><font class="comment">//internal--------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">CH_CahnHilliard_ERROR:: n0( </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; fname  )
</font><font class="comment">//internal--------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ostringstream</font><font class="text"> msg ;
   msg &lt;&lt; </font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="string">&quot;*** CH_CahnHilliard:&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;    unable to open file \&quot;&quot; &lt;&lt; fname &lt;&lt; &quot;</font><font class="text">\</font><font class="string">&quot;&quot;</font><font class="text"> ;
   </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain( msg.str() ) ;
}


</font>
</pre>
</body>
</html>
