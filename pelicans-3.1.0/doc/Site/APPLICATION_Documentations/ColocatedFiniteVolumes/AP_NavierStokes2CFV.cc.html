<html>
<head>
<title>AP_NavierStokes2CFV.cc</title>
<link rel=stylesheet type="text/css" href="stylesheet.css">
</head>
<body>
<pre>
<font class="comment">/*
 *  Copyright 1995-2010 by IRSN
 *
 *  This software is an application framework, with a set of integrated  
 *  reusable components, whose purpose is to simplify the task of developing 
 *  softwares of numerical mathematics and scientific computing.
 * 
 *  This software is governed by the CeCILL-C license under French law and 
 *  abiding by the rules of distribution of free software. You can use, modify 
 *  and/or redistribute the software under the terms of the CeCILL-C license  
 *  as circulated by CEA, CNRS and INRIA at the following URL 
 *  &quot;http://www.cecill.info&quot;. 
 *
 *  As a counterpart to the access to the source code and rights to copy,  
 *  modify and redistribute granted by the license, users are provided only 
 *  with a limited warranty and the software's author, the holder of the  
 *  economic rights, and the successive licensors have only limited liability. 
 *
 *  In this respect, the user's attention is drawn to the risks associated  
 *  with loading, using, modifying and/or developing or reproducing the  
 *  software by the user in light of its specific status of free software,
 *  that may mean that it is complicated to manipulate, and that also  
 *  therefore means that it is reserved for developers and experienced 
 *  professionals having in-depth computer knowledge. Users are therefore 
 *  encouraged to load and test the software's suitability as regards their 
 *  requirements in conditions enabling the security of their systems and/or 
 *  data to be ensured and, more generally, to use and operate it in the same 
 *  conditions as regards security. 
 *
 *  The fact that you are presently reading this means that you have had 
 *  knowledge of the CeCILL-C license and that you accept its terms.
 */
</font><font class="text">
</font><font class="kw2">#include</font><font class="text"> &lt;AP_NavierStokes2CFV.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_ContextSimple</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Double</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_DoubleVector</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Error</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_ModuleExplorer</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Variable</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Vector</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">LA_SeqVector</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">LA_Solver</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">LA_SeqMatrix</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_Color</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_Mpolyhedron</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_QRprovider</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_Point</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_Vector</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_CursorFEside</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_DiscreteField</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_DomainAndFields</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LocalEquation</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LocalFEbound</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LocalFEcell</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_SetOfBCs</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_SetOfDiscreteFields</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_SystemNumbering</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE_Parameter</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE_SetOfParameters</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE_TimeIterator</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;AP_NavierStokes1System.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;ios&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;iomanip&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;iostream&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;fstream&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;sstream&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw2">string</font><font class="text">&gt;

</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">cout</font><font class="text"> ; </font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ios_base</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">setprecision</font><font class="text"> ; </font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">setw</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ostringstream</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::ofstream ;

AP_NavierStokes2CFV </font><font class="kw1">const</font><font class="text">* 
AP_NavierStokes2CFV::PROTOTYPE = </font><font class="kw1">new</font><font class="text"> AP_NavierStokes2CFV() ;

</font><font class="kw1">struct</font><font class="text"> AP_NavierStokes2CFV_ERROR
{
   </font><font class="kw1">static</font><font class="text"> </font><font class="kw1">void</font><font class="text"> n0( </font><font class="kw3">PDE_LocalFEbound</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe, </font><font class="kw1">double</font><font class="text"> int_v_nor ) ;
   </font><font class="kw1">static</font><font class="text"> </font><font class="kw1">void</font><font class="text"> n1( </font><font class="kw3">PEL_ModuleExplorer</font><font class="text"> </font><font class="kw1">const</font><font class="text">* exp,
                   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; keyword, 
                   </font><font class="kw2">size_t</font><font class="text"> size) ;
   </font><font class="kw1">static</font><font class="text"> </font><font class="kw1">void</font><font class="text"> n2( </font><font class="kw1">void</font><font class="text"> ) ;
} ;

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">AP_NavierStokes2CFV:: AP_NavierStokes2CFV( </font><font class="kw1">void</font><font class="text"> )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">   : </font><font class="kw3">FE_OneStepIterationOpen</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV&quot;</font><font class="text"> )
{
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">AP_NavierStokes2CFV*
AP_NavierStokes2CFV:: create_replica( </font><font class="kw3">PEL_Object</font><font class="text">* a_owner,
                                           </font><font class="kw3">PDE_DomainAndFields</font><font class="text"> </font><font class="kw1">const</font><font class="text">* dom,
                                           </font><font class="kw3">FE_SetOfParameters</font><font class="text"> </font><font class="kw1">const</font><font class="text">* prms,
                                           </font><font class="kw3">PEL_ModuleExplorer</font><font class="text">* exp ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: create_replica&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( create_replica_PRE( a_owner, dom, prms, exp ) ) ;

   AP_NavierStokes2CFV* result = 
                      </font><font class="kw1">new</font><font class="text"> AP_NavierStokes2CFV( a_owner, dom, prms, exp ) ;

   </font><font class="kw3">PEL_CHECK</font><font class="text">( create_replica_POST( result, a_owner, dom, prms, exp ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">AP_NavierStokes2CFV:: AP_NavierStokes2CFV( 
                                           </font><font class="kw3">PEL_Object</font><font class="text">* a_owner,
                                           </font><font class="kw3">PDE_DomainAndFields</font><font class="text"> </font><font class="kw1">const</font><font class="text">* dom,
                                           </font><font class="kw3">FE_SetOfParameters</font><font class="text"> </font><font class="kw1">const</font><font class="text">* prms,
                                           </font><font class="kw3">PEL_ModuleExplorer</font><font class="text"> </font><font class="kw1">const</font><font class="text">* exp )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">   : </font><font class="kw3">FE_OneStepIterationOpen</font><font class="text">( a_owner, dom, exp )
   , UU( dom-&gt;set_of_discrete_fields()-&gt;item( 
                                       exp-&gt;string_data( </font><font class="string">&quot;velocity&quot;</font><font class="text"> ) ) )
   , L_UPDATE_UU( exp-&gt;int_data( </font><font class="string">&quot;velocity_level_to_update&quot;</font><font class="text"> ) )
   , L_EXPLICIT_UU( </font><font class="kw3">PEL</font><font class="text">::bad_index() )
   , PP( dom-&gt;set_of_discrete_fields()-&gt;item( 
                                       exp-&gt;string_data( </font><font class="string">&quot;pressure&quot;</font><font class="text"> ) ) )
   , L_UPDATE_PP( exp-&gt;int_data( </font><font class="string">&quot;pressure_level_to_update&quot;</font><font class="text"> ) )
   , L_EXPLICIT_PP( </font><font class="kw3">PEL</font><font class="text">::bad_index() )
   , IS_UNSTEADY( </font><font class="kw1">false</font><font class="text"> )
   , C_DT( 0.0 )
   , C_VGRAD( exp-&gt;double_data( </font><font class="string">&quot;coef_vgrad_v&quot;</font><font class="text"> ) )
   , MU( exp-&gt;double_data( </font><font class="string">&quot;coef_viscous&quot;</font><font class="text"> ) )
   , PI( prms-&gt;item( exp-&gt;string_data( </font><font class="string">&quot;param_source&quot;</font><font class="text"> ) ) )
   , NB_ITER_MAX( exp-&gt;int_data( </font><font class="string">&quot;nb_iterations_max&quot;</font><font class="text"> ) )
   , RELAX( exp-&gt;has_entry( </font><font class="string">&quot;relaxation_coefficient&quot;</font><font class="text"> ) ? 
            exp-&gt;double_data( </font><font class="string">&quot;relaxation_coefficient&quot;</font><font class="text"> ) : 1.0 )
   , TOL( exp-&gt;double_data( </font><font class="string">&quot;newton_tolerance&quot;</font><font class="text"> ) )
   , LAMBDA( exp-&gt;double_data( </font><font class="string">&quot;lambda_in_pressure_stabilization&quot;</font><font class="text"> ) ) 
   , h_EXPONENT( exp-&gt;double_data( </font><font class="string">&quot;h_exponent_in_infsup_stabilization&quot;</font><font class="text"> ) )
   , CLUSTER_BD( 0 )
   , BCs( dom-&gt;set_of_boundary_conditions() )
   , sFE( dom-&gt;create_CursorFEside( </font><font class="kw1">this</font><font class="text"> ) )
   , bFE( dom-&gt;create_LocalFEbound( </font><font class="kw1">this</font><font class="text"> ) )
   , cFE( dom-&gt;create_LocalFEcell( </font><font class="kw1">this</font><font class="text"> ) )
   , QRP_PI( </font><font class="kw3">GE_QRprovider</font><font class="text">::object( 
             exp-&gt;string_data( </font><font class="string">&quot;quadrature_rule_provider_for_source&quot;</font><font class="text"> ) ) )
   , idx_UU( 0 )
   , idx_PP( 1 )
   , X_LOC( </font><font class="kw3">LA_SeqVector</font><font class="text">::create( </font><font class="kw1">this</font><font class="text">, 0 ) )
   , CONTEXT( </font><font class="kw3">PEL_ContextSimple</font><font class="text">::create( </font><font class="kw1">this</font><font class="text"> ) )
   , XX( 0 )
   , TT( 0 )
{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: AP_NavierStokes2CFV&quot;</font><font class="text"> ) ;

   check_field_storage_depth( UU, L_UPDATE_UU ) ;
   check_field_storage_depth( PP, L_UPDATE_PP ) ;

   </font><font class="kw1">if</font><font class="text">( exp-&gt;has_module( </font><font class="string">&quot;unsteady&quot;</font><font class="text"> ) )
   {
      IS_UNSTEADY = </font><font class="kw1">true</font><font class="text"> ;
      </font><font class="kw3">PEL_ModuleExplorer</font><font class="text"> </font><font class="kw1">const</font><font class="text">* se = exp-&gt;create_subexplorer( 0, </font><font class="string">&quot;unsteady&quot;</font><font class="text"> ) ;
      L_EXPLICIT_UU = se-&gt;int_data( </font><font class="string">&quot;level_of_explicit_velocity&quot;</font><font class="text"> ) ;
      C_DT = se-&gt;double_data( </font><font class="string">&quot;coef_dt_v&quot;</font><font class="text"> ) ;
      se-&gt;destroy() ;

      check_field_storage_depth( UU, L_EXPLICIT_UU ) ;
      </font><font class="kw1">if</font><font class="text">( L_UPDATE_UU == L_EXPLICIT_UU )
         AP_NavierStokes2CFV_ERROR::n2() ;
   }

   check_param_nb_components( PI, </font><font class="string">&quot;source&quot;</font><font class="text">, 
                              dom-&gt;nb_space_dimensions() ) ;

   sFE-&gt;require_field_calculation( UU, </font><font class="kw3">PDE_LocalFE</font><font class="text">::node ) ;
   bFE-&gt;require_field_calculation( UU, </font><font class="kw3">PDE_LocalFE</font><font class="text">::node ) ;
   cFE-&gt;require_field_calculation( UU, </font><font class="kw3">PDE_LocalFE</font><font class="text">::node ) ;
   cFE-&gt;require_field_calculation( PP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::node ) ;

   sFE-&gt;require_field_calculation( PP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::node ) ;
   bFE-&gt;require_field_calculation( PP, </font><font class="kw3">PDE_LocalFE</font><font class="text">::node ) ;

   PI-&gt;transfer_side_calculation_requirements( sFE, </font><font class="kw3">FE_Parameter</font><font class="text">::Val ) ;
   PI-&gt;transfer_bound_calculation_requirements( bFE, </font><font class="kw3">FE_Parameter</font><font class="text">::Val ) ;
   PI-&gt;transfer_cell_calculation_requirements( cFE, </font><font class="kw3">FE_Parameter</font><font class="text">::Val ) ;

   </font><font class="kw1">if</font><font class="text">( exp-&gt;has_entry( </font><font class="string">&quot;color_of_cluster_boundaries&quot;</font><font class="text"> ) )
   {
      CLUSTER_BD = </font><font class="kw3">GE_Color</font><font class="text">::object(
                   exp-&gt;string_data( </font><font class="string">&quot;color_of_cluster_boundaries&quot;</font><font class="text"> ) ) ;
   }

   </font><font class="comment">//*****************
</font><font class="text">   </font><font class="comment">// if the boundary conditions are &quot;Dirichlet&quot; on the whole boundary,
</font><font class="text">   </font><font class="comment">// the pressure at node 0 is imposed
</font><font class="text">   </font><font class="comment">//*****************
</font><font class="text">   PP-&gt;modify_DOF( </font><font class="kw1">true</font><font class="text">, PP-&gt;DOF_value( 0, 0, 0 ), 0 ) ;

   </font><font class="kw3">PEL_Vector</font><font class="text">* vec = </font><font class="kw3">PEL_Vector</font><font class="text">::create( 0, 2 ) ;
   vec-&gt;set_at( idx_UU, </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text">::create( 0, UU,
                                             </font><font class="string">&quot;sequence_of_the_components&quot;</font><font class="text">,
                                             </font><font class="kw1">true</font><font class="text"> ) ) ;
   vec-&gt;set_at( idx_PP, </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text">::create( 0, PP, </font><font class="kw1">true</font><font class="text"> ) ) ;
   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> ordering = </font><font class="string">&quot;sequence_of_the_discrete_fields&quot;</font><font class="text"> ;
   NMB = </font><font class="kw3">PDE_SystemNumbering</font><font class="text">::create( </font><font class="kw1">this</font><font class="text">, vec, ordering ) ;  
   vec-&gt;destroy() ; vec = 0 ;

   </font><font class="comment">//*****************
</font><font class="text">   </font><font class="comment">// on pourrait eviter d'assembler toute la jacobienne en conservant
</font><font class="text">   </font><font class="comment">// sur un niveau particulier les termes qui ne dependent pas des
</font><font class="text">   </font><font class="comment">// iterations de Newton
</font><font class="text">   </font><font class="comment">//*****************
</font><font class="text">
   </font><font class="kw3">PEL_ModuleExplorer</font><font class="text"> </font><font class="kw1">const</font><font class="text">* ee = exp-&gt;create_subexplorer( 0, </font><font class="string">&quot;LA_Matrix&quot;</font><font class="text"> ) ;
   A = </font><font class="kw3">LA_Matrix</font><font class="text">::make( </font><font class="kw1">this</font><font class="text">, ee ) ;
   ee-&gt;destroy() ; ee = 0 ;

   F = A-&gt;create_vector( </font><font class="kw1">this</font><font class="text"> ) ;
   X = A-&gt;create_vector( </font><font class="kw1">this</font><font class="text"> ) ;
   
   </font><font class="kw2">size_t</font><font class="text"> nb_global_unk = NMB-&gt;nb_global_unknowns() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_local_unk  = NMB-&gt;nb_unknowns_on_current_process() ;

   A-&gt;re_initialize( nb_global_unk, nb_global_unk,
                     nb_local_unk, nb_local_unk ) ;
   F-&gt;re_initialize( nb_global_unk, nb_local_unk ) ;
   X-&gt;re_initialize( nb_global_unk, nb_local_unk ) ;

   NMB-&gt;define_scatters( X ) ;

   </font><font class="kw2">size_t</font><font class="text"> nn = NMB-&gt;link( 0 )-&gt;unknown_vector_size() ;
   </font><font class="kw2">size_t</font><font class="text"> mm = NMB-&gt;link( 1 )-&gt;unknown_vector_size() ;
   </font><font class="kw1">if</font><font class="text">( mm &gt; nn ) nn = mm ;
   X_LOC-&gt;re_initialize( nn ) ;
   
   ee = exp-&gt;create_subexplorer( 0, </font><font class="string">&quot;LA_Solver&quot;</font><font class="text"> ) ;
   SOLVER = </font><font class="kw3">LA_Solver</font><font class="text">::make( </font><font class="kw1">this</font><font class="text">, ee ) ;
   ee-&gt;destroy() ; ee = 0 ;

   XX = </font><font class="kw3">PEL_DoubleVector</font><font class="text">::create( CONTEXT, </font><font class="kw3">doubleVector</font><font class="text">( 0 ) ) ;
   CONTEXT-&gt;extend( </font><font class="kw3">PEL_Variable</font><font class="text">::object(</font><font class="string">&quot;DV_X&quot;</font><font class="text">), XX ) ;

   TT = </font><font class="kw3">PEL_Double</font><font class="text">::create( CONTEXT, 0.0 ) ;
   CONTEXT-&gt;extend( </font><font class="kw3">PEL_Variable</font><font class="text">::object(</font><font class="string">&quot;DS_T&quot;</font><font class="text">), TT ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">AP_NavierStokes2CFV:: ~AP_NavierStokes2CFV( </font><font class="kw1">void</font><font class="text"> )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw2">size_t
</font><font class="text">AP_NavierStokes2CFV:: nb_unknowns( </font><font class="kw1">void</font><font class="text"> ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw1">return</font><font class="text">( 2 ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">PDE_DiscreteField</font><font class="text">*
AP_NavierStokes2CFV:: field( </font><font class="kw2">size_t</font><font class="text"> i_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: field&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( field_PRE( i_unk ) ) ;

   </font><font class="kw3">PDE_DiscreteField</font><font class="text">* result = 0 ;
   </font><font class="kw1">if</font><font class="text">( i_unk == idx_UU ) result = UU ;
   </font><font class="kw1">if</font><font class="text">( i_unk == idx_PP ) result = PP ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( field_POST( result, i_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw2">size_t
</font><font class="text">AP_NavierStokes2CFV:: level_of_field( </font><font class="kw2">size_t</font><font class="text"> i_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: level_of_field&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( level_of_field_PRE( i_unk ) ) ;

   </font><font class="kw2">size_t</font><font class="text"> result = </font><font class="kw3">PEL</font><font class="text">::bad_index() ;
   </font><font class="kw1">if</font><font class="text">( i_unk == idx_UU ) result = L_UPDATE_UU ;
   </font><font class="kw1">if</font><font class="text">( i_unk == idx_PP ) result = L_UPDATE_PP ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( level_of_field_POST( result, i_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text"> </font><font class="kw1">const</font><font class="text">*
AP_NavierStokes2CFV:: link_DOF_2_unknown( </font><font class="kw2">size_t</font><font class="text"> i_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: link_DOF_2_unknown&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( link_DOF_2_unknown_PRE( i_unk ) ) ;

   </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text"> </font><font class="kw1">const</font><font class="text">* result = NMB-&gt;link( i_unk ) ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( link_DOF_2_unknown_POST( result, i_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: build_function_and_jacobian( 
                                           </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: build_function_and_jacobian&quot;</font><font class="text"> ) ;
   
   A-&gt;nullify() ;
   F-&gt;nullify() ;

   start_assembling_timer() ;
   </font><font class="comment">// ---------------------
</font><font class="text">
   loop_on_cells( t_it ) ;
   loop_on_sides( t_it ) ;
   loop_on_bounds( t_it ) ;

   A-&gt;synchronize() ;
   F-&gt;synchronize() ;
   
   stop_assembling_timer() ;
   </font><font class="comment">// --------------------
</font><font class="text">}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">LA_SeqVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">*
AP_NavierStokes2CFV:: create_function( </font><font class="kw3">PEL_Object</font><font class="text">* a_owner,
                                            </font><font class="kw2">size_t</font><font class="text"> i_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: create_function&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( create_function_PRE( a_owner, i_unk ) ) ;

   </font><font class="kw2">size_t</font><font class="text"> nn = NMB-&gt;link( i_unk )-&gt;unknown_vector_size() ;
   </font><font class="kw3">LA_SeqVector</font><font class="text">* result = </font><font class="kw3">LA_SeqVector</font><font class="text">::create( a_owner, nn ) ;
   NMB-&gt;scatter( i_unk )-&gt;get( F, result ) ;
   
   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( create_function_POST( result, a_owner, i_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">LA_SeqMatrix</font><font class="text"> </font><font class="kw1">const</font><font class="text">*
AP_NavierStokes2CFV:: create_jacobian( </font><font class="kw3">PEL_Object</font><font class="text">* a_owner,
                                            </font><font class="kw2">size_t</font><font class="text"> i_eq, 
                                            </font><font class="kw2">size_t</font><font class="text"> j_unk ) </font><font class="kw1">const
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: create_jacobian&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( create_jacobian_PRE( a_owner, i_eq, j_unk ) ) ;
   
   </font><font class="kw3">LA_SeqMatrix</font><font class="text"> </font><font class="kw1">const</font><font class="text">* result =
                </font><font class="kw3">PDE</font><font class="text">::create_extracted_block( a_owner, A, NMB, i_eq, j_unk ) ;
   
   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( create_jacobian_POST( result, a_owner, i_eq, j_unk ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">void</font><font class="text"> 
AP_NavierStokes2CFV:: do_one_inner_iteration( </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it ) 
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: do_one_inner_iteration&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( do_one_inner_iteration_PRE( t_it ) ) ;

   start_total_timer( </font><font class="string">&quot;AP_NavierStokes2CFV:: do_one_inner_iteration&quot;</font><font class="text"> ) ;
   </font><font class="comment">// --------------
</font><font class="text">
   </font><font class="kw2">size_t</font><font class="text"> iter = 0 ;
   </font><font class="kw1">do
</font><font class="text">   {
      iter++ ;
      </font><font class="kw1">if</font><font class="text">( iter &gt;= NB_ITER_MAX )
         </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain( </font><font class="string">&quot;Newton convergence failure&quot;</font><font class="text"> ) ;

      build_function_and_jacobian( t_it ) ;

      start_solving_timer() ;
      </font><font class="comment">// ------------------
</font><font class="text">
      </font><font class="comment">//??? Assuming that the matrix strusture doesn't change ?
</font><font class="text">      </font><font class="kw1">if</font><font class="text">( SOLVER-&gt;matrix_is_set() )
         SOLVER-&gt;reset_matrix() ;
      </font><font class="kw1">else
</font><font class="text">         SOLVER-&gt;set_matrix( A ) ;
      
      SOLVER-&gt;solve( F, X ) ;
      
      </font><font class="kw1">if</font><font class="text">( !SOLVER-&gt;solution_is_achieved() )
      {
         </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain(
            </font><font class="string">&quot;AP_NavierStokes2CFV:: do_one_inner_iteration\n&quot;
</font><font class="text">            </font><font class="string">&quot;    Linear system resolution failure\n&quot;</font><font class="text"> ) ;
      }

      stop_solving_timer() ;
      </font><font class="comment">// -----------------
</font><font class="text">
      </font><font class="kw3">LA_Scatter</font><font class="text"> </font><font class="kw1">const</font><font class="text">* sca = NMB-&gt;scatter( idx_UU ) ;
      </font><font class="kw3">PDE_LinkDOF2Unknown</font><font class="text"> </font><font class="kw1">const</font><font class="text">* link = NMB-&gt;link( idx_UU ) ;
      </font><font class="kw3">PEL_ASSERT</font><font class="text">( UU == link-&gt;field() ) ;
      sca-&gt;get( X, X_LOC ) ;
      UU-&gt;add_to_free_DOFs_value( L_UPDATE_UU, X_LOC, link, RELAX ) ;
      </font><font class="kw1">if</font><font class="text">( verbose_level() &gt;= 1 ) PRINTED_RES_UU = X_LOC-&gt;max_norm() ;

      sca = NMB-&gt;scatter( idx_PP ) ;
      link = NMB-&gt;link( idx_PP ) ;
      </font><font class="kw3">PEL_ASSERT</font><font class="text">( PP == link-&gt;field() ) ;
      sca-&gt;get( X, X_LOC ) ;
      PP-&gt;add_to_free_DOFs_value( L_UPDATE_PP, X_LOC, link, RELAX ) ;
      </font><font class="kw1">if</font><font class="text">( verbose_level() &gt;= 1 ) PRINTED_RES_PP = X_LOC-&gt;max_norm() ;      
      
   } </font><font class="kw1">while</font><font class="text">( !convergence_achieved( iter ) ) ;

   stop_total_timer() ;
   </font><font class="comment">// ---------------
</font><font class="text">}

</font><font class="comment">//------------------------------------------------------------------------
</font><font class="kw1">bool
</font><font class="text">AP_NavierStokes2CFV:: convergence_achieved( </font><font class="kw2">size_t</font><font class="text"> iter ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: convergence_achieved&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">double</font><font class="text"> rhs = F-&gt;two_norm() ;
   </font><font class="kw1">bool</font><font class="text"> result = ( rhs &lt; TOL ) ;

   </font><font class="kw1">if</font><font class="text">( verbose_level() &gt;= 1 )
   {
      </font><font class="kw2">ios_base</font><font class="text">::</font><font class="kw2">fmtflags</font><font class="text"> original_flags = </font><font class="kw3">PEL</font><font class="text">::out().</font><font class="kw2">flags</font><font class="text">() ;
      </font><font class="kw3">PEL</font><font class="text">::out().setf( </font><font class="kw2">ios_base</font><font class="text">::</font><font class="kw2">uppercase</font><font class="text"> | </font><font class="kw2">ios_base</font><font class="text">::</font><font class="kw2">scientific</font><font class="text"> ) ;

      </font><font class="kw1">if</font><font class="text">( iter==1 )
      {
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; indent()
                    &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 3+15 ) &lt;&lt; </font><font class="string">&quot;max(d_U)&quot;</font><font class="text"> 
                    &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 15 )   &lt;&lt; </font><font class="string">&quot;max(d_P)&quot;</font><font class="text"> 
                    &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 15 )   &lt;&lt; </font><font class="string">&quot;L2(rhs)&quot;</font><font class="text"> ;
         </font><font class="kw1">if</font><font class="text">( SOLVER-&gt;is_iterative() )
            </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 9 ) &lt;&lt; </font><font class="string">&quot;its&quot;</font><font class="text"> ;
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
      }
      </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; indent() 
                 &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 3 ) &lt;&lt; iter
                 &lt;&lt; </font><font class="kw2">setprecision</font><font class="text">( 6 ) &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 15 )
                 &lt;&lt; PRINTED_RES_UU
                 &lt;&lt; </font><font class="kw2">setprecision</font><font class="text">( 6 ) &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 15 ) 
                 &lt;&lt; PRINTED_RES_PP
                 &lt;&lt; </font><font class="kw2">setprecision</font><font class="text">( 6 ) &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 15 ) 
                 &lt;&lt; rhs ;
      </font><font class="kw1">if</font><font class="text">( SOLVER-&gt;is_iterative() )
      {
         </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">setw</font><font class="text">( 9 ) &lt;&lt; SOLVER-&gt;nb_iterations_achieved() ;
      }
      </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
      </font><font class="kw3">PEL</font><font class="text">::out().</font><font class="kw2">flags</font><font class="text">( original_flags ) ;
   }

   </font><font class="kw1">return</font><font class="text">( result ) ;
}
   
</font><font class="comment">//************************************************************************
// L'implementation de cette fonction est trop longue et
// devrait etre splittee pour mieux faire apparaitre les diff&#xE9;rents termes
//************************************************************************
//------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: loop_on_sides( </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it )
</font><font class="comment">//------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: loop_on_sides&quot;</font><font class="text"> ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_dims = sFE-&gt;nb_space_dimensions() ;
   </font><font class="kw1">double</font><font class="text"> xx  = </font><font class="kw3">PEL</font><font class="text">::bad_double() ;
   </font><font class="kw1">double</font><font class="text"> rhs = </font><font class="kw3">PEL</font><font class="text">::bad_double() ;

   </font><font class="kw2">size_t</font><font class="text"> nb_done = 0 ;
   </font><font class="kw2">size_t</font><font class="text"> nb_skip = 0 ;

   </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe_K = sFE-&gt;adjacent_localFEcell( 0 ) ;
   </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe_L = sFE-&gt;adjacent_localFEcell( 1 ) ;
   
   </font><font class="kw1">for</font><font class="text">( sFE-&gt;start() ; sFE-&gt;is_valid() ; sFE-&gt;go_next() )
   {
      </font><font class="kw3">GE_Color</font><font class="text"> </font><font class="kw1">const</font><font class="text">* color = sFE-&gt;color() ;
      </font><font class="kw1">bool</font><font class="text"> do_stab = ( CLUSTER_BD == 0 ) ||
           ( (CLUSTER_BD != 0) &amp;&amp; !color-&gt;is_matching( CLUSTER_BD ) ) ;

      </font><font class="kw2">size_t</font><font class="text"> n_v_K = fe_K-&gt;global_node( UU, 0 ) ;
      </font><font class="kw2">size_t</font><font class="text"> n_v_L = fe_L-&gt;global_node( UU, 0 ) ;
      </font><font class="kw2">size_t</font><font class="text"> n_p_K = fe_K-&gt;global_node( PP, 0 ) ;
      </font><font class="kw2">size_t</font><font class="text"> n_p_L = fe_L-&gt;global_node( PP, 0 ) ;

      </font><font class="kw2">size_t</font><font class="text"> u_p_K, u_p_L ;
      </font><font class="kw1">double</font><font class="text"> value_p_K, value_p_L ;

      </font><font class="kw1">if</font><font class="text">( NMB-&gt;link( idx_PP )-&gt;DOF_is_unknown( n_p_K, 0 ) )
      {
         u_p_K = NMB-&gt;global_unknown_for_DOF( n_p_K, 0, idx_PP ) ;
         value_p_K = PP-&gt;DOF_value( L_UPDATE_UU, n_p_K, 0 ) ;
      }
      </font><font class="kw1">else
</font><font class="text">      {
         u_p_K = </font><font class="kw3">PEL</font><font class="text">::bad_index() ;
         value_p_K = PP-&gt;DOF_imposed_value( n_p_K, 0 ) ;
      }

      </font><font class="kw1">if</font><font class="text">( NMB-&gt;link( idx_PP )-&gt;DOF_is_unknown( n_p_L, 0 ) )
      {
         u_p_L = NMB-&gt;global_unknown_for_DOF( n_p_L, 0, idx_PP ) ;
         value_p_L = PP-&gt;DOF_value( L_UPDATE_UU, n_p_L, 0 ) ;
      }
      </font><font class="kw1">else
</font><font class="text">      {
         u_p_L = </font><font class="kw3">PEL</font><font class="text">::bad_index() ;
         value_p_L = PP-&gt;DOF_imposed_value( n_p_L, 0 ) ;
      }

      </font><font class="kw3">GE_Vector</font><font class="text"> </font><font class="kw1">const</font><font class="text">* normal = sFE-&gt;normal() ;

      </font><font class="kw1">double</font><font class="text"> area = </font><font class="kw3">FE</font><font class="text">::side_measure( sFE ) ;

      </font><font class="kw1">double</font><font class="text"> d_K = sFE-&gt;distance_to_adjacent_finite_volume_center( 0 ) ;
      </font><font class="kw1">double</font><font class="text"> d_L = sFE-&gt;distance_to_adjacent_finite_volume_center( 1 ) ;
      </font><font class="kw1">double</font><font class="text"> d_KL = d_K + d_L ;

      </font><font class="kw1">double</font><font class="text"> rhs_stab = 0.0 ;
      </font><font class="kw1">double</font><font class="text"> csta = 0.0 ;
      </font><font class="kw1">if</font><font class="text">( do_stab )
      {
         nb_done++ ;
         </font><font class="kw1">double</font><font class="text"> h_K = fe_K-&gt;polyhedron()-&gt;inter_vertices_maximum_distance() ;
         </font><font class="kw1">double</font><font class="text"> h_L = fe_L-&gt;polyhedron()-&gt;inter_vertices_maximum_distance() ;
         csta = LAMBDA * ( </font><font class="kw3">PEL</font><font class="text">::pow( h_K, h_EXPONENT ) + 
                           </font><font class="kw3">PEL</font><font class="text">::pow( h_L, h_EXPONENT ) ) * area ;

         rhs_stab = csta * ( value_p_K - value_p_L ) ;
         </font><font class="kw1">if</font><font class="text">( u_p_K != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) add_to_G_item( u_p_K,  rhs_stab ) ;
         </font><font class="kw1">if</font><font class="text">( u_p_L != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) add_to_G_item( u_p_L, -rhs_stab ) ;

         xx = -csta ;
         </font><font class="kw1">if</font><font class="text">( u_p_K != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) add_to_C_item( u_p_K, u_p_K,  xx ) ;
         </font><font class="kw1">if</font><font class="text">( u_p_L != </font><font class="kw3">PEL</font><font class="text">::bad_index() &amp;&amp; u_p_K != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) 
            add_to_C_item( u_p_L, u_p_K, -xx ) ;

         xx = -xx ;
         </font><font class="kw1">if</font><font class="text">( u_p_K != </font><font class="kw3">PEL</font><font class="text">::bad_index() &amp;&amp; u_p_K != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) 
            add_to_C_item( u_p_K, u_p_L,  xx ) ;
         </font><font class="kw1">if</font><font class="text">( u_p_L != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) add_to_C_item( u_p_L, u_p_L, -xx ) ;
      }
      </font><font class="kw1">else
</font><font class="text">      {
         nb_skip++ ;
      }

      </font><font class="kw1">double</font><font class="text"> conv_flux = 0.0 ; 
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
      {
         conv_flux += ( UU-&gt;DOF_value( L_UPDATE_UU, n_v_K, ic ) * d_L + 
                        UU-&gt;DOF_value( L_UPDATE_UU, n_v_L, ic ) * d_K ) 
                      * normal-&gt;component( ic ) ;
      }
      conv_flux = conv_flux * area / d_KL ;

      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
      {
         </font><font class="kw2">size_t</font><font class="text"> u_v_K = NMB-&gt;global_unknown_for_DOF( n_v_K, ic, idx_UU ) ;
         </font><font class="kw2">size_t</font><font class="text"> u_v_L = NMB-&gt;global_unknown_for_DOF( n_v_L, ic, idx_UU ) ;

         </font><font class="kw1">double</font><font class="text"> value_v_K = UU-&gt;DOF_value( L_UPDATE_UU, n_v_K, ic ) ;
         </font><font class="kw1">double</font><font class="text"> value_v_L = UU-&gt;DOF_value( L_UPDATE_UU, n_v_L, ic ) ;

         </font><font class="comment">// *** div( v v )
</font><font class="text">
         rhs = - C_VGRAD * conv_flux * 0.5 * ( value_v_K + value_v_L ) 
               - C_VGRAD * rhs_stab  * 0.5 * value_v_K ;
         add_to_F_item( u_v_K,  rhs ) ;
         add_to_F_item( u_v_L, -rhs ) ;

         xx = C_VGRAD * ( conv_flux + rhs_stab ) * 0.5 ;
         add_to_A_item( u_v_K, u_v_K,  xx ) ;
         add_to_A_item( u_v_L, u_v_K, -xx ) ;

         xx = C_VGRAD * conv_flux * 0.5 ;
         add_to_A_item( u_v_K, u_v_L,  xx ) ;
         add_to_A_item( u_v_L, u_v_L, -xx ) ;

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> jc=0 ; jc&lt;nb_dims ; ++jc )
         {
            </font><font class="kw2">size_t</font><font class="text"> uKj = NMB-&gt;global_unknown_for_DOF( n_v_K, jc, idx_UU ) ;
            xx = C_VGRAD * 0.5 *( value_v_K + value_v_L ) * 
                              area * d_L / d_KL * normal-&gt;component( jc ) ;
            add_to_A_item( u_v_K, uKj,  xx ) ;
            add_to_A_item( u_v_L, uKj, -xx ) ;

            </font><font class="kw2">size_t</font><font class="text"> uLj = NMB-&gt;global_unknown_for_DOF( n_v_L, jc, idx_UU ) ;
            xx = C_VGRAD * 0.5 *( value_v_K + value_v_L ) * 
                              area * d_K / d_KL * normal-&gt;component( jc ) ;
            add_to_A_item( u_v_K, uLj,  xx ) ;
            add_to_A_item( u_v_L, uLj, -xx ) ;
         }
         
         </font><font class="kw1">if</font><font class="text">( do_stab )
         {
            xx = C_VGRAD * csta * 0.5 * value_v_K ;
            add_to_D_item( u_v_K, u_p_K,  xx ) ;
            add_to_D_item( u_v_L, u_p_K, -xx ) ;

            xx = -xx ;
            add_to_D_item( u_v_K, u_p_L,  xx ) ;
            add_to_D_item( u_v_L, u_p_L, -xx ) ;
         }

         </font><font class="comment">// *** - delta(v) 
</font><font class="text">
         xx = MU * area / d_KL ;
         add_to_A_item( u_v_K, u_v_K,  xx ) ;
         add_to_A_item( u_v_L, u_v_K, -xx ) ;

         rhs = - xx * ( value_v_K - value_v_L ) ;
         add_to_F_item( u_v_K,  rhs ) ;
         add_to_F_item( u_v_L, -rhs ) ;

         xx = - MU * area / d_KL ;
         add_to_A_item( u_v_K, u_v_L,  xx ) ;
         add_to_A_item( u_v_L, u_v_L, -xx ) ;

         </font><font class="comment">// *** -div(v)
</font><font class="text">
         xx = - area * d_L / d_KL * normal-&gt;component( ic ) ;
         add_to_B_item( u_p_K, u_v_K,  xx ) ;
         add_to_D_item( u_v_K, u_p_K,  xx ) ;
         add_to_B_item( u_p_L, u_v_K, -xx ) ;
         add_to_D_item( u_v_K, u_p_L, -xx ) ;

         xx = - area * d_K / d_KL * normal-&gt;component( ic ) ;
         add_to_B_item( u_p_K, u_v_L,  xx ) ;
         add_to_D_item( u_v_L, u_p_K,  xx ) ;
         add_to_B_item( u_p_L, u_v_L, -xx ) ;
         add_to_D_item( u_v_L, u_p_L, -xx ) ;

         rhs = area * ( d_L * value_v_K + d_K * value_v_L ) / d_KL 
                    * normal-&gt;component( ic ) ;
         add_to_G_item( u_p_K,  rhs ) ;
         add_to_G_item( u_p_L, -rhs ) ;

         rhs = area * d_L * ( value_p_K - value_p_L ) / d_KL
                    * normal-&gt;component( ic ) ;
         add_to_F_item( u_v_K,  rhs ) ;
         rhs = area * d_K * ( value_p_K - value_p_L ) / d_KL
                    * normal-&gt;component( ic ) ;
         add_to_F_item( u_v_L,  rhs ) ;
      }
   }

   </font><font class="kw1">if</font><font class="text">( verbose_level() &gt;= 2 )
   {
      </font><font class="kw3">PEL</font><font class="text">::out() &lt;&lt; indent() &lt;&lt; </font><font class="string">&quot;   stabilization computed on &quot;</font><font class="text"> 
                 &lt;&lt; nb_done &lt;&lt; </font><font class="string">&quot; sides (&quot;</font><font class="text"> &lt;&lt; nb_skip &lt;&lt; </font><font class="string">&quot; skipped)&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   }
}

</font><font class="comment">//------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: loop_on_bounds( </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it )
</font><font class="comment">//------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: loop_on_bounds&quot;</font><font class="text"> ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_dims = bFE-&gt;nb_space_dimensions() ;

   </font><font class="kw1">for</font><font class="text">( bFE-&gt;start() ; bFE-&gt;is_valid() ; bFE-&gt;go_next() )
   {
      </font><font class="kw3">GE_Color</font><font class="text"> </font><font class="kw1">const</font><font class="text">* color = bFE-&gt;color() ;

      </font><font class="kw3">PEL_ModuleExplorer</font><font class="text"> </font><font class="kw1">const</font><font class="text">* ee = BCs-&gt;BC_explorer( color, UU ) ;

      </font><font class="kw2">size_t</font><font class="text"> n_v_K = bFE-&gt;global_node( UU, 0 ) ;
      </font><font class="kw2">size_t</font><font class="text"> n_p_K = bFE-&gt;global_node( PP, 0 ) ;

      </font><font class="kw3">GE_Vector</font><font class="text"> </font><font class="kw1">const</font><font class="text">* normal = bFE-&gt;outward_normal() ;
      </font><font class="kw1">double</font><font class="text"> area = </font><font class="kw3">FE</font><font class="text">::bound_measure( bFE ) ;

      </font><font class="kw1">double</font><font class="text"> conv_flux = 0.0 ;

      </font><font class="kw2">string</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; type = ee-&gt;string_data( </font><font class="string">&quot;type&quot;</font><font class="text"> ) ;
      </font><font class="kw1">if</font><font class="text">( type == </font><font class="string">&quot;Dirichlet&quot;</font><font class="text"> )
      {
         </font><font class="kw3">GE_Point</font><font class="text"> </font><font class="kw1">const</font><font class="text">* pt = bFE-&gt;polyhedron()-&gt;center() ;
         XX-&gt;</font><font class="kw2">set</font><font class="text">( pt-&gt;coordinate_vector() ) ;
         TT-&gt;</font><font class="kw2">set</font><font class="text">( t_it-&gt;time() ) ;
         </font><font class="kw3">doubleVector</font><font class="text"> uimp = 
                      ee-&gt;doubleVector_data( </font><font class="string">&quot;imposed_value&quot;</font><font class="text">, CONTEXT ) ;
         </font><font class="kw1">if</font><font class="text">( uimp.size() != nb_dims ) 
            AP_NavierStokes2CFV_ERROR::n1( ee, </font><font class="string">&quot;imposed_value&quot;</font><font class="text">, nb_dims );

         </font><font class="kw1">double</font><font class="text"> h = bFE-&gt;distance_to_adjacent_finite_volume_center() ;

         </font><font class="kw1">double</font><font class="text"> xx_l = MU * area / h ;

         </font><font class="kw1">double</font><font class="text"> uimp_nor = 0.0 ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
         {
            </font><font class="kw2">size_t</font><font class="text"> u_v_K = NMB-&gt;global_unknown_for_DOF( n_v_K, ic, idx_UU ) ;
            </font><font class="kw1">double</font><font class="text"> value_v_K = UU-&gt;DOF_value( L_UPDATE_UU, n_v_K, ic ) ;
            add_to_A_item( u_v_K, u_v_K, xx_l ) ;
            add_to_F_item( u_v_K, -xx_l*( value_v_K - uimp( ic ) ) ) ; 

            uimp_nor += uimp( ic ) * normal-&gt;component( ic ) ;
         }
         
         </font><font class="kw2">size_t</font><font class="text"> u_p_K ;
         </font><font class="kw1">double</font><font class="text"> value_p_K ;

         </font><font class="kw1">if</font><font class="text">( NMB-&gt;link( idx_PP )-&gt;DOF_is_unknown( n_p_K, 0 ) )
         {
            u_p_K = NMB-&gt;global_unknown_for_DOF( n_p_K, 0, idx_PP ) ;
            value_p_K = PP-&gt;DOF_value( L_UPDATE_UU, n_p_K, 0 ) ;
         }
         </font><font class="kw1">else
</font><font class="text">         {
            u_p_K = </font><font class="kw3">PEL</font><font class="text">::bad_index() ;
            value_p_K = PP-&gt;DOF_imposed_value( n_p_K, 0 ) ;
         }

         </font><font class="kw1">if</font><font class="text">( u_p_K != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) add_to_G_item( u_p_K, uimp_nor*area ) ;

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
         {
            conv_flux += uimp( ic ) * normal-&gt;component( ic ) ;
         }
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
         {
            </font><font class="kw2">size_t</font><font class="text"> u_v_K = NMB-&gt;global_unknown_for_DOF( n_v_K, ic, idx_UU ) ;
            add_to_F_item( u_v_K, - C_VGRAD * area * conv_flux * uimp(ic) ) ; 
         }
      }
      </font><font class="kw1">else
</font><font class="text">         raise_bad_BC_type( type, </font><font class="string">&quot;\&quot;</font><font class="text">Dirichlet\</font><font class="string">&quot;&quot;</font><font class="text">, UU ) ;
   }
}

</font><font class="comment">//------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: loop_on_cells( </font><font class="kw3">FE_TimeIterator</font><font class="text"> </font><font class="kw1">const</font><font class="text">* t_it )
</font><font class="comment">//------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: loop_on_cells&quot;</font><font class="text"> ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_dims = cFE-&gt;nb_space_dimensions() ;

   </font><font class="kw1">for</font><font class="text">( cFE-&gt;start() ; cFE-&gt;is_valid() ; cFE-&gt;go_next() )
   {
      </font><font class="kw2">size_t</font><font class="text"> n_v_K = cFE-&gt;global_node( UU, 0 ) ;

      </font><font class="kw3">doubleVector</font><font class="text"> int_source( nb_dims ) ;
      cFE-&gt;start_IP_iterator( QRP_PI ) ;
      </font><font class="kw1">for</font><font class="text">( ; cFE-&gt;valid_IP() ; cFE-&gt;go_next_IP() )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
         {
            int_source( d ) += cFE-&gt;weight_of_IP() * 
                               PI-&gt;cell_value_at_IP( t_it, cFE, d ) ;
         }
      }

      </font><font class="kw1">double</font><font class="text"> vol = </font><font class="kw3">FE</font><font class="text">::cell_measure( cFE ) ;
      </font><font class="kw1">double</font><font class="text"> xx_l = vol * C_DT / t_it-&gt;time_step();

      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
      {
         </font><font class="kw2">size_t</font><font class="text"> u_v_K = NMB-&gt;global_unknown_for_DOF( n_v_K, ic, idx_UU ) ;
         </font><font class="kw1">double</font><font class="text"> xx_r = - int_source( ic ) ;
         </font><font class="kw1">if</font><font class="text">( IS_UNSTEADY )
         {
            xx_r += xx_l * ( UU-&gt;DOF_value( L_UPDATE_UU, n_v_K, ic ) - 
                             UU-&gt;DOF_value( L_EXPLICIT_UU, n_v_K, ic ) ) ;
            add_to_A_item( u_v_K, u_v_K, xx_l ) ;
         }
         add_to_F_item( u_v_K, -xx_r ) ; 
      }
   }
}

</font><font class="comment">//************************************************************************
// Les fonctions add_to_*_item sont des survivances du pass&#xE9;
// ---&gt; a supprimer ???
//************************************************************************
</font><font class="text">
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: add_to_A_item( </font><font class="kw2">size_t</font><font class="text"> i_row, 
                                          </font><font class="kw2">size_t</font><font class="text"> j_col, 
                                          </font><font class="kw1">double</font><font class="text"> xx )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: add_to_A_item&quot;</font><font class="text"> ) ;

   </font><font class="comment">// no imposed dof for velocity
</font><font class="text">   </font><font class="kw3">PEL_ASSERT</font><font class="text">( i_row != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) ;
   </font><font class="kw3">PEL_ASSERT</font><font class="text">( j_col != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) ;

   A-&gt;add_to_item( i_row, j_col, xx ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: add_to_F_item( </font><font class="kw2">size_t</font><font class="text"> i_row, </font><font class="kw1">double</font><font class="text"> xx )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: add_to_F_item&quot;</font><font class="text"> ) ;

   </font><font class="kw3">PEL_ASSERT</font><font class="text">( i_row != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) ;

   F-&gt;add_to_item( i_row, xx ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: add_to_B_item( </font><font class="kw2">size_t</font><font class="text"> i_row, 
                                          </font><font class="kw2">size_t</font><font class="text"> j_col, 
                                          </font><font class="kw1">double</font><font class="text"> xx )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: add_to_B_item&quot;</font><font class="text"> ) ;

   </font><font class="kw3">PEL_ASSERT</font><font class="text">( j_col != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) ;

   </font><font class="kw1">if</font><font class="text">( i_row != </font><font class="kw3">PEL</font><font class="text">::bad_index() )
   {
      A-&gt;add_to_item( i_row, j_col, xx ) ;
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: add_to_D_item( </font><font class="kw2">size_t</font><font class="text"> i_row, 
                                          </font><font class="kw2">size_t</font><font class="text"> j_col, 
                                          </font><font class="kw1">double</font><font class="text"> xx )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: add_to_D_item&quot;</font><font class="text"> ) ;

   </font><font class="kw3">PEL_ASSERT</font><font class="text">( i_row != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) ;

   </font><font class="kw1">if</font><font class="text">( j_col != </font><font class="kw3">PEL</font><font class="text">::bad_index() )
   {
      A-&gt;add_to_item( i_row, j_col, xx ) ;
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: add_to_G_item( </font><font class="kw2">size_t</font><font class="text"> i_row, </font><font class="kw1">double</font><font class="text"> xx )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: add_to_G_item&quot;</font><font class="text"> ) ;

   </font><font class="kw1">if</font><font class="text">( i_row != </font><font class="kw3">PEL</font><font class="text">::bad_index() )
   {
      F-&gt;add_to_item( i_row, xx ) ;
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV:: add_to_C_item( </font><font class="kw2">size_t</font><font class="text"> i_row, 
                                          </font><font class="kw2">size_t</font><font class="text"> j_col, 
                                          </font><font class="kw1">double</font><font class="text"> xx )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;AP_NavierStokes2CFV:: add_to_C_item&quot;</font><font class="text"> ) ;

   </font><font class="kw1">if</font><font class="text">( ( i_row != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) &amp;&amp; ( j_col != </font><font class="kw3">PEL</font><font class="text">::bad_index() ) )
   {
      A-&gt;add_to_item( i_row, j_col, xx ) ;
   }
}

</font><font class="comment">//internal--------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV_ERROR:: n0( </font><font class="kw3">PDE_LocalFEbound</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                                     </font><font class="kw1">double</font><font class="text"> int_v_nor )
</font><font class="comment">//internal--------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ostringstream</font><font class="text"> msg ;
   msg &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="string">&quot;*** AP_NavierStokes2CFV:&quot;</font><font class="text"> 
       &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;the bound : &quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   fe-&gt;print_current_mesh( msg , 6 ) ;
   msg &lt;&lt; </font><font class="string">&quot;is an inflow bound, but it does not have&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;a Dirichlet boundary condition&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;advective flux : &quot;</font><font class="text"> &lt;&lt; int_v_nor ;
   </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain( msg.str() ) ;
}

</font><font class="comment">//internal--------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV_ERROR:: n1( </font><font class="kw3">PEL_ModuleExplorer</font><font class="text"> </font><font class="kw1">const</font><font class="text">* exp,
                                     </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; keyword,
                                     </font><font class="kw2">size_t</font><font class="text"> size )
</font><font class="comment">//internal--------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ostringstream</font><font class="text"> msg ;
   msg &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="string">&quot;*** AP_NavierStokes2CFV:&quot;</font><font class="text"> 
       &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;In module: &quot;</font><font class="text"> &lt;&lt; exp-&gt;absolute_path_name() &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;the data of keyword: &quot;</font><font class="text"> &lt;&lt; keyword &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;should be a DoubleVector of size: &quot;</font><font class="text"> &lt;&lt; size ;
   </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain( msg.str() ) ;
}

</font><font class="comment">//internal--------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">AP_NavierStokes2CFV_ERROR:: n2( </font><font class="kw1">void</font><font class="text"> )
</font><font class="comment">//internal--------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ostringstream</font><font class="text"> msg ;
   msg &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="string">&quot;*** AP_NavierStokes2CFV:&quot;</font><font class="text"> 
       &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> &lt;&lt; </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;the data of keyword: \&quot;</font><font class="text">velocity_level_to_update\</font><font class="string">&quot;&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;                and: \&quot;</font><font class="text">level_of_explicit_velocity\</font><font class="string">&quot;&quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   msg &lt;&lt; </font><font class="string">&quot;should be different&quot;</font><font class="text"> ;
   </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain( msg.str() ) ;
}

</font>
</pre>
</body>
</html>
