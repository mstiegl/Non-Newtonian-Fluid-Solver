<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">
<html>
<head>
  <title>EXT_MPIcommunicator.cc</title>
  <link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
</head>
<script>
  function asd()
  {
    parent.document.title="EXT_MPIcommunicator.cc_PELICANS 17_03_2010 ";
  }
</script> 

<body onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<div id=navbar>
  <a name="navbar_top_firstrow"><!-- --></a>
  <div id=navbarapp>PELICANS 17_03_2010</div>
  <div id=navbarmenu>
    <a href="PELpack-tree.html"><span>Tree</span></a>
    <a href="EXT_MPIcommunicator.html"><span>Class</span></a>
    <a href="EXT_MPIcommunicator.hh.html"><span>Header</span></a>
    <span class=selected>Implementation</span>
    <div id=navbarsub>
      <a href="index.html" target="_top">FRAMES :</a>
      <a href="PELpack-tree.html" target="_top">: NO FRAMES</a>
    </div>
  </div>
</div>
<!-- ========== END OF NAVBAR ========== -->

<pre>
<font class="comment">/*
 *  Copyright 1995-2010 by IRSN
 *
 *  This software is an application framework, with a set of integrated  
 *  reusable components, whose purpose is to simplify the task of developing 
 *  softwares of numerical mathematics and scientific computing.
 * 
 *  This software is governed by the CeCILL-C license under French law and 
 *  abiding by the rules of distribution of free software. You can use, modify 
 *  and/or redistribute the software under the terms of the CeCILL-C license  
 *  as circulated by CEA, CNRS and INRIA at the following URL 
 *  &quot;http://www.cecill.info&quot;. 
 *
 *  As a counterpart to the access to the source code and rights to copy,  
 *  modify and redistribute granted by the license, users are provided only 
 *  with a limited warranty and the software's author, the holder of the  
 *  economic rights, and the successive licensors have only limited liability. 
 *
 *  In this respect, the user's attention is drawn to the risks associated  
 *  with loading, using, modifying and/or developing or reproducing the  
 *  software by the user in light of its specific status of free software,
 *  that may mean that it is complicated to manipulate, and that also  
 *  therefore means that it is reserved for developers and experienced 
 *  professionals having in-depth computer knowledge. Users are therefore 
 *  encouraged to load and test the software's suitability as regards their 
 *  requirements in conditions enabling the security of their systems and/or 
 *  data to be ensured and, more generally, to use and operate it in the same 
 *  conditions as regards security. 
 *
 *  The fact that you are presently reading this means that you have had 
 *  knowledge of the CeCILL-C license and that you accept its terms.
 */
</font><font class="text">
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Error</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_assertions</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">doubleVector</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">intVector</font><font class="text">.hh&gt;

</font><font class="comment">// Both stdio.h and the MPI C++ interface use SEEK_SET, SEEK_CUR, SEEK_END.
// This is really a bug in the MPI-2 standard.
// A possibility would be to undefine the 3 names SEEK_SET, SEEK_CUR, SEEK_END
//    #undef SEEK_SET
//    #undef SEEK_CUR
//    #undef SEEK_END
// Our solution is to define MPICH_IGNORE_CXX_SEEK which works at least 
// with MPICH2
</font><font class="kw2">#define</font><font class="text"> MPICH_IGNORE_CXX_SEEK 1
</font><font class="kw2">#include</font><font class="text"> &lt;mpi.h&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;iostream&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;sstream&gt;

</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">ostringstream</font><font class="text"> ;
</font><font class="kw1">using</font><font class="text"> </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">endl</font><font class="text"> ;

</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">*
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: SINGLETON = </font><font class="kw1">new</font><font class="text"> </font><font class="kw3">EXT_MPIcommunicator</font><font class="text">() ;
   
</font><font class="kw1">struct</font><font class="text"> EXT_MPIcommunicator_ERROR
{
   </font><font class="kw1">static</font><font class="text"> </font><font class="kw1">void</font><font class="text"> n0( </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; func ) ;
} ;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Timer</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Map</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Root</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_Root</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;sys/time.h&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;sys/resource.h&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;unistd.h&gt;


</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: </font><font class="kw3">EXT_MPIcommunicator</font><font class="text">( </font><font class="kw1">void</font><font class="text"> )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">   : </font><font class="kw3">PEL_Communicator</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator&quot;</font><font class="text"> )
{
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: ~</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">( </font><font class="kw1">void</font><font class="text"> )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   SINGLETON = 0 ;
   
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw2">size_t
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: rank( </font><font class="kw1">void</font><font class="text"> ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: rank&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">static</font><font class="text"> </font><font class="kw2">size_t</font><font class="text"> result = </font><font class="kw3">PEL</font><font class="text">::bad_index() ;
   </font><font class="kw1">if</font><font class="text">( result==</font><font class="kw3">PEL</font><font class="text">::bad_index() )
   {
      </font><font class="kw1">int</font><font class="text"> tmp ;
      </font><font class="kw1">int</font><font class="text">  mpierr = MPI_Comm_rank( MPI_COMM_WORLD, &amp;tmp ) ;
      </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
         EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Comm_rank&quot;</font><font class="text"> ) ;
      result = (</font><font class="kw2">size_t</font><font class="text">) tmp ;
   }

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( rank_POST( result ) ) ;   
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw2">size_t
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: nb_ranks( </font><font class="kw1">void</font><font class="text"> ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: nb_ranks&quot;</font><font class="text"> ) ;

   </font><font class="kw1">static</font><font class="text"> </font><font class="kw2">size_t</font><font class="text"> result = </font><font class="kw3">PEL</font><font class="text">::bad_index() ;
   </font><font class="kw1">if</font><font class="text">( result==</font><font class="kw3">PEL</font><font class="text">::bad_index() )
   {
      </font><font class="kw1">int</font><font class="text"> tmp ;
      </font><font class="kw1">int</font><font class="text">  mpierr = MPI_Comm_size( MPI_COMM_WORLD, &amp;tmp ) ;
      </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
         EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Comm_size&quot;</font><font class="text"> ) ;
      result = (</font><font class="kw2">size_t</font><font class="text">) tmp ;
   }

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( nb_ranks_POST( result ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: send( </font><font class="kw2">size_t</font><font class="text"> dest, </font><font class="kw1">int</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: send( int const* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( send_PRE( dest, value, nb ) ) ;

   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Send( (</font><font class="kw1">void</font><font class="text">*)</font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">int</font><font class="text">*&gt;(value),
                           nb, MPI_INT, dest, TAG_INT, MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS )
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Send(int*)&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: send( </font><font class="kw2">size_t</font><font class="text"> dest, </font><font class="kw1">double</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: send( double const* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( send_PRE( dest, value, nb ) ) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Send( (</font><font class="kw1">void</font><font class="text">*)</font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">double</font><font class="text">*&gt;(value),
                          nb, MPI_DOUBLE, dest, TAG_DOUBLE, MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Send(double*)&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: send( </font><font class="kw2">size_t</font><font class="text"> dest, </font><font class="kw1">char</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: send( char const* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( send_PRE( dest, value, nb ) ) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Send( (</font><font class="kw1">void</font><font class="text">*)</font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">char</font><font class="text">*&gt;(value),
                          nb, MPI_CHAR, dest, TAG_CHAR, MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Send(char*)&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void</font><font class="text">*
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: Isend( </font><font class="kw2">size_t</font><font class="text"> dest, </font><font class="kw1">int</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: Isend( int const* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( send_PRE( dest, value, nb ) ) ;
   
   MPI_Request* request = </font><font class="kw1">new</font><font class="text"> MPI_Request ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Isend( (</font><font class="kw1">void</font><font class="text">*)</font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">int</font><font class="text">*&gt;(value),
                            nb, MPI_INT, dest, TAG_INT, MPI_COMM_WORLD,
                            request ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS )
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Isend(int*)&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">return</font><font class="text">( request ) ;
   
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void</font><font class="text">*
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: Ireceive( </font><font class="kw2">size_t</font><font class="text"> src, </font><font class="kw1">int</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: Ireceive( int* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( receive_PRE( src, value, nb ) ) ;
   MPI_Request* request = </font><font class="kw1">new</font><font class="text"> MPI_Request ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Irecv( (</font><font class="kw1">void</font><font class="text">*)value,
                            nb, MPI_INT, src, TAG_INT, MPI_COMM_WORLD,
                            request ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS )
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Irecv(int*)&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">return</font><font class="text">( request ) ;
   
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void</font><font class="text">*
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: Isend( </font><font class="kw2">size_t</font><font class="text"> dest, </font><font class="kw1">double</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: Isend( double const* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( send_PRE( dest, value, nb ) ) ;
   MPI_Request* request = </font><font class="kw1">new</font><font class="text"> MPI_Request ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Isend( (</font><font class="kw1">void</font><font class="text">*)</font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">double</font><font class="text">*&gt;(value),
                           nb, MPI_DOUBLE, dest, TAG_DOUBLE, MPI_COMM_WORLD,
                           request ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Isend(double*)&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">return</font><font class="text">( request ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void</font><font class="text">*
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: Ireceive( </font><font class="kw2">size_t</font><font class="text"> src, </font><font class="kw1">double</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: Ireceive( double* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( receive_PRE( src, value, nb ) ) ;
   MPI_Request* request = </font><font class="kw1">new</font><font class="text"> MPI_Request ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Irecv( (</font><font class="kw1">void</font><font class="text">*)value,
                           nb, MPI_DOUBLE, src, TAG_DOUBLE, MPI_COMM_WORLD,
                           request ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Irecv(double*)&quot;</font><font class="text"> ) ;

   </font><font class="kw1">return</font><font class="text">( request ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: wait( </font><font class="kw1">void</font><font class="text">* request  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: wait&quot;</font><font class="text"> ) ;
   
   MPI_Status status ;
   MPI_Request* r = (MPI_Request*) request ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Wait( r, &amp;status ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_wait&quot;</font><font class="text"> ) ;

   </font><font class="kw1">delete</font><font class="text"> (MPI_Request*)r ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: receive( </font><font class="kw2">size_t</font><font class="text"> src, </font><font class="kw1">int</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: receive( int const* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( receive_PRE( src, value, nb ) ) ;

   </font><font class="kw1">static</font><font class="text"> MPI_Status status ;
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Recv( (</font><font class="kw1">void</font><font class="text">*)value, nb, MPI_INT, src, TAG_INT,
                          MPI_COMM_WORLD, &amp;status ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr!=MPI_SUCCESS || status.MPI_ERROR!=MPI_SUCCESS )
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Recv(int*)&quot;</font><font class="text"> ) ;

   </font><font class="kw3">PEL_CHECK</font><font class="text">( MPI_Get_count( &amp;status, MPI_INT, &amp;count )==MPI_SUCCESS &amp;&amp;
              count==nb ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: receive( </font><font class="kw2">size_t</font><font class="text"> src, </font><font class="kw1">double</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: receive( double* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( receive_PRE( src, value, nb ) ) ;

   </font><font class="kw1">static</font><font class="text"> MPI_Status status ;
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Recv( (</font><font class="kw1">void</font><font class="text">*)value, nb, MPI_DOUBLE, src, TAG_DOUBLE,
                          MPI_COMM_WORLD, &amp;status ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr!=MPI_SUCCESS || status.MPI_ERROR!=MPI_SUCCESS )
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Recv(double*)&quot;</font><font class="text"> ) ;

   </font><font class="kw3">PEL_CHECK</font><font class="text">( MPI_Get_count( &amp;status, MPI_DOUBLE, &amp;count )==MPI_SUCCESS &amp;&amp;
              count==nb ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: receive( </font><font class="kw2">size_t</font><font class="text"> src, </font><font class="kw1">char</font><font class="text">* value, </font><font class="kw1">int</font><font class="text"> nb  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: receive( char* )&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( receive_PRE( src, value, nb ) ) ;

   </font><font class="kw1">static</font><font class="text"> MPI_Status status ;
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Recv( (</font><font class="kw1">void</font><font class="text">*)value, nb, MPI_CHAR, src, TAG_CHAR,
                          MPI_COMM_WORLD, &amp;status ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr!=MPI_SUCCESS || status.MPI_ERROR!=MPI_SUCCESS )
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Recv&quot;</font><font class="text"> ) ;

   </font><font class="kw3">PEL_CHECK</font><font class="text">( MPI_Get_count( &amp;status, MPI_CHAR, &amp;count )==MPI_SUCCESS &amp;&amp;
              count==nb ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: all_gather( </font><font class="kw1">int</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value,
                                  </font><font class="kw2">size_t</font><font class="text"> nb,
                                  </font><font class="kw1">int</font><font class="text">* result  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: all_gather(int)&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Allgather( </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">void</font><font class="text">*&gt;((</font><font class="kw1">void</font><font class="text"> </font><font class="kw1">const</font><font class="text">*)value), 
                                nb, MPI_INT,
                                result, nb, MPI_INT, MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Allgather&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">::  all_gather_v( </font><font class="kw1">double</font><font class="text"> </font><font class="kw1">const</font><font class="text">* values,
                                     </font><font class="kw2">size_t</font><font class="text"> nb,
                                     </font><font class="kw1">double</font><font class="text">* result,
                                     </font><font class="kw3">intVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; partition,
                                     </font><font class="kw3">intVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; start ) </font><font class="kw1">const</font><font class="text"> 
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: all_gather_v(double vector)&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( partition.size()==nb_ranks() ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Allgatherv( </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">void</font><font class="text">*&gt;((</font><font class="kw1">void</font><font class="text"> </font><font class="kw1">const</font><font class="text">*)values), 
                                 nb, MPI_DOUBLE,
                                 result, </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">int</font><font class="text">*&gt;(partition.data()),
                                 </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">int</font><font class="text">*&gt;(start.data()),
                                 MPI_DOUBLE, MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Allgatherv&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: all_to_all( </font><font class="kw1">int</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value, </font><font class="kw2">size_t</font><font class="text"> nb,
                                  </font><font class="kw1">int</font><font class="text">* result  ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: all_to_all(int)&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Alltoall( </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">void</font><font class="text">*&gt;((</font><font class="kw1">void</font><font class="text"> </font><font class="kw1">const</font><font class="text">*)value), 
                               nb, MPI_INT,
                               result, nb, MPI_INT, MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Alltoall&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: gather( </font><font class="kw1">double</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value,</font><font class="kw2">size_t</font><font class="text"> nb,
                              </font><font class="kw1">double</font><font class="text">* result, </font><font class="kw2">size_t</font><font class="text"> root ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: gather(double)&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Gather( </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">void</font><font class="text">*&gt;((</font><font class="kw1">void</font><font class="text"> </font><font class="kw1">const</font><font class="text">*)value), 
                            nb, MPI_DOUBLE,
                            result, nb, MPI_DOUBLE, root, MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Gather&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: gather( </font><font class="kw1">int</font><font class="text"> </font><font class="kw1">const</font><font class="text">* value,</font><font class="kw2">size_t</font><font class="text"> nb,
                              </font><font class="kw1">int</font><font class="text">* result, </font><font class="kw2">size_t</font><font class="text"> root ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: gather(int)&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Gather( </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">void</font><font class="text">*&gt;((</font><font class="kw1">void</font><font class="text"> </font><font class="kw1">const</font><font class="text">*)value), 
                            nb, MPI_INT,
                            result, nb, MPI_INT, root, MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Gather&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: broadcast( </font><font class="kw1">int</font><font class="text">* value, </font><font class="kw2">size_t</font><font class="text"> nb, </font><font class="kw2">size_t</font><font class="text"> root ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: broadcast(int*)&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Bcast( (</font><font class="kw1">void</font><font class="text">*)(value), nb, MPI_INT, root,
                            MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_broadcast(int*)&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: broadcast( </font><font class="kw1">double</font><font class="text">* value, </font><font class="kw2">size_t</font><font class="text"> nb, </font><font class="kw2">size_t</font><font class="text"> root ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: broadcast(double*)&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Bcast( (</font><font class="kw1">void</font><font class="text">*)(value), nb, MPI_DOUBLE, root,
                            MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_broadcast(double*)&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: broadcast( </font><font class="kw1">char</font><font class="text">* value, </font><font class="kw2">size_t</font><font class="text"> nb, </font><font class="kw2">size_t</font><font class="text"> root ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: broadcast(char*)&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr =  MPI_Bcast( (</font><font class="kw1">void</font><font class="text">*)(value), nb, MPI_CHAR, root,
                            MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_broadcast(char*)&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">bool
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: same_value_everywhere( </font><font class="kw1">int</font><font class="text"> val ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: same_value_everywhere(int)&quot;</font><font class="text"> ) ;
   </font><font class="comment">// PEL_CHECK_COLLECTIVE(true) ; //??? Recursive call of
</font><font class="text">                                   </font><font class="comment">//??? PEL_Maker::is_collective()
</font><font class="text">
   </font><font class="kw3">intVector</font><font class="text"> other( nb_ranks() ) ;
   </font><font class="kw1">int</font><font class="text"> aval=val ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Gather(
                    </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">void</font><font class="text">*&gt;( (</font><font class="kw1">void</font><font class="text"> </font><font class="kw1">const</font><font class="text">*) &amp;aval ),
                    1, MPI_INT,
                    (</font><font class="kw1">void</font><font class="text">*) other.data(), 1, MPI_INT, 0,
                    MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Gather&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">int</font><font class="text"> ok = 1 ;
   </font><font class="kw1">if</font><font class="text">( rank()==0 )
   {
      
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_ranks() ; i++ )
      {
         </font><font class="kw1">if</font><font class="text">( other(i)!=val )
         {
            ok = 0 ;
         }
      }
   }   
   mpierr =  MPI_Bcast( (</font><font class="kw1">void</font><font class="text">*)(&amp;ok), 1, MPI_INT, 0,
                        MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Bcast&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">return</font><font class="text">( ok==1 ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">bool
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: same_value_everywhere( </font><font class="kw1">double</font><font class="text"> val ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: same_value_everywhere(double)&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;

   </font><font class="kw3">doubleVector</font><font class="text"> other( nb_ranks() ) ;
   </font><font class="kw1">double</font><font class="text"> aval=val ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Gather(
                    </font><font class="kw1">const_cast</font><font class="text">&lt;</font><font class="kw1">void</font><font class="text">*&gt;( (</font><font class="kw1">void</font><font class="text"> </font><font class="kw1">const</font><font class="text">*) &amp;aval ),
                    1, MPI_DOUBLE,
                    (</font><font class="kw1">void</font><font class="text">*) other.data(), 1, MPI_DOUBLE, 0,
                    MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Gather&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">int</font><font class="text"> ok = 1 ;
   </font><font class="kw1">if</font><font class="text">( rank()==0 )
   {
      
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_ranks() ; i++ )
      {
         </font><font class="kw1">if</font><font class="text">( other(i)!=val )
         {
            ok = 0 ;
         }
      }
   }   
   mpierr =  MPI_Bcast( (</font><font class="kw1">void</font><font class="text">*)(&amp;ok), 1, MPI_INT, 0,
                        MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Bcast&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">return</font><font class="text">( ok==1 ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">bool
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: boolean_and( bool value ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: boolean_and&quot;</font><font class="text"> ) ;  
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> input = ( </font><font class="kw1">int</font><font class="text"> ) value ;
   </font><font class="kw1">int</font><font class="text"> result ;

   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Allreduce( (</font><font class="kw1">void</font><font class="text">*)(&amp;input), (</font><font class="kw1">void</font><font class="text">*)(&amp;result),
                               1, MPI_INT, MPI_LAND, MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Allreduce and&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">return</font><font class="text">( (</font><font class="kw1">bool</font><font class="text">) result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">bool
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: boolean_or( bool value ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: boolean_or&quot;</font><font class="text"> ) ;   
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> input = (</font><font class="kw1">int</font><font class="text">) value ;
   </font><font class="kw1">int</font><font class="text"> result ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Allreduce( (</font><font class="kw1">void</font><font class="text">*)(&amp;input), (</font><font class="kw1">void</font><font class="text">*)(&amp;result),
                               1, MPI_INT, MPI_LOR, MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Allreduce or&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">return</font><font class="text">( (</font><font class="kw1">bool</font><font class="text">) result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">double
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: sum( </font><font class="kw1">double</font><font class="text"> value ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: sum&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">double</font><font class="text"> result ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Allreduce( (</font><font class="kw1">void</font><font class="text">*)(&amp;value), (</font><font class="kw1">void</font><font class="text">*)(&amp;result),
                               1, MPI_DOUBLE, MPI_SUM, MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Allreduce sum&quot;</font><font class="text"> ) ;
   
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">double
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: max( </font><font class="kw1">double</font><font class="text"> value ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: max&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">double</font><font class="text"> result ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Allreduce( (</font><font class="kw1">void</font><font class="text">*)(&amp;value), (</font><font class="kw1">void</font><font class="text">*)(&amp;result),
                               1, MPI_DOUBLE, MPI_MAX, MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Allreduce max&quot;</font><font class="text"> ) ;
   
   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( max_POST( result, value ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">double
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: min( </font><font class="kw1">double</font><font class="text"> value ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: min&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">double</font><font class="text"> result ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Allreduce( (</font><font class="kw1">void</font><font class="text">*)(&amp;value), (</font><font class="kw1">void</font><font class="text">*)(&amp;result),
                               1, MPI_DOUBLE, MPI_MIN, MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Allreduce min&quot;</font><font class="text"> ) ;
   
   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( min_POST( result, value ) ) ;
   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: sum_vector( </font><font class="kw1">double</font><font class="text">* values, </font><font class="kw1">int</font><font class="text"> nb ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: sum_vector(double*)&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK</font><font class="text">( sum_vector_PRE( values, nb ) ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">double</font><font class="text">* result = </font><font class="kw1">new</font><font class="text"> </font><font class="kw1">double</font><font class="text">[nb] ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Allreduce( values, result,
                               nb, MPI_DOUBLE, MPI_SUM,
                               MPI_COMM_WORLD ) ;
   
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Allreduce sum_vector&quot;</font><font class="text"> ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb ; ++i ) values[i] = result[i] ;  
   </font><font class="kw1">delete</font><font class="text"> [] result ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">EXT_MPIcommunicator</font><font class="text">:: barrier( </font><font class="kw1">void</font><font class="text"> ) </font><font class="kw1">const
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;EXT_MPIcommunicator:: barrier&quot;</font><font class="text"> ) ;
   PEL_CHECK_COLLECTIVE(</font><font class="kw1">true</font><font class="text">) ;
   
   </font><font class="kw1">int</font><font class="text"> mpierr = MPI_Barrier( MPI_COMM_WORLD ) ;
   </font><font class="kw1">if</font><font class="text">( mpierr != MPI_SUCCESS ) 
      EXT_MPIcommunicator_ERROR::n0( </font><font class="string">&quot;MPI_Barrier&quot;</font><font class="text"> ) ;
}

</font><font class="comment">//internal---------------------------------------------------------------
</font><font class="kw1">void
</font><font class="text">EXT_MPIcommunicator_ERROR:: n0( </font><font class="kw2">std</font><font class="text">::</font><font class="kw2">string</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; func )
</font><font class="comment">//internal---------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw2">ostringstream</font><font class="text"> mesg ;
   mesg &lt;&lt; </font><font class="string">&quot;*** EXT_MPIcommunicator : &quot;</font><font class="text"> &lt;&lt; </font><font class="kw2">endl</font><font class="text"> ;
   mesg &lt;&lt; </font><font class="string">&quot;    call to &quot;</font><font class="text"> &lt;&lt; func &lt;&lt; </font><font class="string">&quot; failed&quot;</font><font class="text"> ;
   </font><font class="kw3">PEL_Error</font><font class="text">::object()-&gt;raise_plain( mesg.str() ) ;
}

</font>
</pre>
</body>
</html>
