<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">
<html>
<head>
  <title>FE.cc</title>
  <link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
</head>
<script>
  function asd()
  {
    parent.document.title="FE.cc_PELICANS 17_03_2010 ";
  }
</script> 

<body onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<div id=navbar>
  <a name="navbar_top_firstrow"><!-- --></a>
  <div id=navbarapp>PELICANS 17_03_2010</div>
  <div id=navbarmenu>
    <a href="FEpack-tree.html"><span>Tree</span></a>
    <a href="FE.html"><span>Class</span></a>
    <a href="FE.hh.html"><span>Header</span></a>
    <span class=selected>Implementation</span>
    <div id=navbarsub>
      <a href="index.html" target="_top">FRAMES :</a>
      <a href="FEpack-tree.html" target="_top">: NO FRAMES</a>
    </div>
  </div>
</div>
<!-- ========== END OF NAVBAR ========== -->

<pre>
<font class="comment">/*
 *  Copyright 1995-2010 by IRSN
 *
 *  This software is an application framework, with a set of integrated  
 *  reusable components, whose purpose is to simplify the task of developing 
 *  softwares of numerical mathematics and scientific computing.
 * 
 *  This software is governed by the CeCILL-C license under French law and 
 *  abiding by the rules of distribution of free software. You can use, modify 
 *  and/or redistribute the software under the terms of the CeCILL-C license  
 *  as circulated by CEA, CNRS and INRIA at the following URL 
 *  &quot;http://www.cecill.info&quot;. 
 *
 *  As a counterpart to the access to the source code and rights to copy,  
 *  modify and redistribute granted by the license, users are provided only 
 *  with a limited warranty and the software's author, the holder of the  
 *  economic rights, and the successive licensors have only limited liability. 
 *
 *  In this respect, the user's attention is drawn to the risks associated  
 *  with loading, using, modifying and/or developing or reproducing the  
 *  software by the user in light of its specific status of free software,
 *  that may mean that it is complicated to manipulate, and that also  
 *  therefore means that it is reserved for developers and experienced 
 *  professionals having in-depth computer knowledge. Users are therefore 
 *  encouraged to load and test the software's suitability as regards their 
 *  requirements in conditions enabling the security of their systems and/or 
 *  data to be ensured and, more generally, to use and operate it in the same 
 *  conditions as regards security. 
 *
 *  The fact that you are presently reading this means that you have had 
 *  knowledge of the CeCILL-C license and that you accept its terms.
 */
</font><font class="text">
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">FE</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">doubleArray2D</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">doubleVector</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_Mpolyhedron</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">GE_Point</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_CursorFEside</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_DiscreteField</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LocalEquation</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LocalFEbound</font><font class="text">.hh&gt;
</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PDE_LocalFEcell</font><font class="text">.hh&gt;

</font><font class="kw2">#include</font><font class="text"> &lt;</font><font class="kw3">PEL_assertions</font><font class="text">.hh&gt;

</font><font class="kw3">PDE_LocalFE</font><font class="text">::field_id </font><font class="kw1">const</font><font class="text"> row = </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ;
</font><font class="kw3">PDE_LocalFE</font><font class="text">::field_id </font><font class="kw1">const</font><font class="text"> col = </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ;

</font><font class="kw3">FE</font><font class="text">::FE_Geometry FE::GEOM = FE::unspecified ;

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw3">FE</font><font class="text">::FE_Geometry
</font><font class="kw3">FE</font><font class="text">:: geometry( </font><font class="kw1">void</font><font class="text"> )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw1">return</font><font class="text">( GEOM ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: set_geometry( FE_Geometry geom )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: set_geometry&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( geom == </font><font class="kw3">FE</font><font class="text">::cartesian || geom == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;

   GEOM = geom ;

   </font><font class="kw3">PEL_CHECK_POST</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == geom ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">double
</font><font class="kw3">FE</font><font class="text">:: bound_measure( </font><font class="kw3">PDE_LocalFEbound</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: bound_measure&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() != </font><font class="kw3">FE</font><font class="text">::unspecified ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;

   </font><font class="kw1">double</font><font class="text"> result = fe-&gt;polyhedron()-&gt;measure() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      result *= fe-&gt;polyhedron()-&gt;center()-&gt;coordinate(0) ;
   }

   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">double
</font><font class="kw3">FE</font><font class="text">:: side_measure( </font><font class="kw3">PDE_CursorFEside</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: side_measure&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( !fe-&gt;is_periodic() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() != </font><font class="kw3">FE</font><font class="text">::unspecified ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;

   </font><font class="kw3">GE_Mpolyhedron</font><font class="text"> </font><font class="kw1">const</font><font class="text">* poly = fe-&gt;polyhedron() ;
   </font><font class="kw1">double</font><font class="text"> result = poly-&gt;measure() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      result *= poly-&gt;center()-&gt;coordinate( 0 ) ;
   }

   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">double
</font><font class="kw3">FE</font><font class="text">:: side_measure( </font><font class="kw3">PDE_CursorFEside</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe, </font><font class="kw2">size_t</font><font class="text"> i_adj )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: side_measure&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_periodic() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( i_adj==0 || i_adj==1 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() != </font><font class="kw3">FE</font><font class="text">::unspecified ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;

   </font><font class="kw3">GE_Mpolyhedron</font><font class="text"> </font><font class="kw1">const</font><font class="text">* poly = fe-&gt;polyhedron( i_adj ) ;
   </font><font class="kw1">double</font><font class="text"> result = poly-&gt;measure() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      result *= poly-&gt;center()-&gt;coordinate( 0 ) ;
   }

   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">double
</font><font class="kw3">FE</font><font class="text">:: cell_measure( </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: cell_measure&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() != </font><font class="kw3">FE</font><font class="text">::unspecified ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;

   </font><font class="kw1">double</font><font class="text"> result = fe-&gt;polyhedron()-&gt;measure() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      result *= fe-&gt;polyhedron()-&gt;center()-&gt;coordinate(0) ;
   }

   </font><font class="kw1">return</font><font class="text">( result ) ;
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row_col_S( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                    </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                    </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_row_col_S&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;
   
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=i ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> xx = N_row( i ) * N_col( j ) ;
         xx *= c_w ;

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( xx, i, j, ic, ic ) ;
            </font><font class="kw1">if</font><font class="text">( i!=j ) leq-&gt;add_to_matrix( xx, j, i, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row_col_NS( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                     </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                     </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_row_col_NS&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ==
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_row_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_col_nodes = fe-&gt;nb_basis_functions( col ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> xx = N_row( i ) * N_col( j ) ;
         xx *= c_w ;

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( xx, i, j, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_lumped_row_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                         </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                         </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//---------------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_lumped_row_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == fe-&gt;field( col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
   
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> xx = N_row( i ) * c_w ;

      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
      {
         leq-&gt;add_to_matrix( xx, i, i, ic, ic ) ;
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_grad_row_grad_col_S( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                              </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                              </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_grad_row_grad_col_S&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ==
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 1 || 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 
                     fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">(
                     </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical &amp;&amp;
                        fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() != 1,
                     fe-&gt;field_calculation_is_handled(
                        fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() ==
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   
   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field(row)-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;
   
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=i ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> xx = 0.0 ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
         {
            xx += dN_row( i, d ) * dN_col( j, d ) ;
         }
         xx *= c_w ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic &lt; nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( xx, i, j, ic, ic ) ;
            </font><font class="kw1">if</font><font class="text">( i != j ) leq-&gt;add_to_matrix( xx, j, i, ic, ic ) ;
         }
      }
   }

   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical &amp;&amp; nbc != 1 )
   {
      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;
      </font><font class="kw1">double</font><font class="text"> yy = c_w / radius / radius ;
      
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=i ; j&lt;nb_nodes ; ++j )
         {
            </font><font class="kw1">double</font><font class="text"> xx = yy * N_row( i ) * N_col( j ) ;
            leq-&gt;add_to_matrix( xx, i, j, 0, 0 ) ;
            </font><font class="kw1">if</font><font class="text">( i != j ) leq-&gt;add_to_matrix( xx, j, i, 0, 0 ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_grad_row_grad_col_NS( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                               </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                               </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_grad_row_grad_col_NS&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 1 || 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 
                     fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ==
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">(
                     </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical &amp;&amp;
                        fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() != 1,
                     fe-&gt;field_calculation_is_handled(
                        fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">(
                     </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical &amp;&amp;
                        fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() != 1,
                     fe-&gt;field_calculation_is_handled(
                        fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() ==
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field(row)-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_row_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_col_nodes = fe-&gt;nb_basis_functions( col ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> xx = 0.0 ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
         {
            xx += dN_row( i, d ) * dN_col( j, d ) ;
         }
         xx *= c_w ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic &lt; nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( xx, i, j, ic, ic ) ;
         }
      }
   }
   
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical &amp;&amp; nbc != 1 )
   {
      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;
      </font><font class="kw1">double</font><font class="text"> yy = c_w / radius / radius ;
      
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
         {
            </font><font class="kw1">double</font><font class="text"> xx = yy * N_row( i ) * N_col( j ) ;
            leq-&gt;add_to_matrix( xx, i, j, 0, 0 ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
              </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
              </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 1 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; i++ )
   {
      </font><font class="kw1">double</font><font class="text"> xx = c_w * N_row( i ) ;
      leq-&gt;add_to_vector( xx, i ) ;
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
              </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
              </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; coef_1,
              </font><font class="kw1">double</font><font class="text"> coef_2 )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( coef_1.size() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
   </font><font class="kw1">double</font><font class="text"> w = coef_2 * fe-&gt;weight_of_IP() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> yy = w * N_row( i ) ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
      {
         </font><font class="kw1">double</font><font class="text"> xx = yy * coef_1( ic ) ;
         leq-&gt;add_to_vector( xx, i, ic ) ;
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_grad_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                   </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_grad_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical  ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( coef.size() == fe-&gt;nb_space_dimensions() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw1">double</font><font class="text"> w = fe-&gt;weight_of_IP() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> xx = 0.0 ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         xx += dN_row( i, d ) * coef( d ) ;
      }
      xx *= w ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
      {
         leq-&gt;add_to_vector( xx, i, ic ) ;
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_grad_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                   </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_grad_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical  ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( coef.index_bound( 0 ) == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( coef.index_bound( 1 ) == fe-&gt;nb_space_dimensions() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw1">double</font><font class="text"> w = fe-&gt;weight_of_IP() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
 
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
      {
         </font><font class="kw1">double</font><font class="text"> xx = 0.0 ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
         {
            xx += dN_row( i, d ) * coef( ic, d ) ;
         }
         xx *= w ;
         leq-&gt;add_to_vector( xx, i, ic ) ;
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_div_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                  </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                  </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_div_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ==
                     fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;field_calculation_is_handled(
                              fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ),
                              </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
      {
         </font><font class="kw1">double</font><font class="text"> xx = c_w*dN_row( i, ic ) ;
         leq-&gt;add_to_vector( xx, i, ic ) ;
      }
   }
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      </font><font class="comment">// Axisymmetrical : div(f) = df/dr+df/dz+f/r
</font><font class="text">      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
      </font><font class="kw1">double</font><font class="text"> yy = c_w / radius ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
      {
         </font><font class="kw1">double</font><font class="text"> xx = yy * N_row( i ) ;
         leq-&gt;add_to_vector( xx, i, 0 ) ;
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_grad_row_D_col_S( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                           </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe, 
                           </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_grad_row_D_col_S&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ==
                     fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">(
                     </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical &amp;&amp;
                        fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() != 1,
                     fe-&gt;field_calculation_is_handled(
                        fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() ==
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw1">double</font><font class="text"> c_w = coef*fe-&gt;weight_of_IP() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; i++ )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; j++ )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> jc=0 ; jc&lt;nb_dims ; jc++ )
         {
            </font><font class="kw1">double</font><font class="text"> x = c_w * dN_row( i, jc ) ;
            </font><font class="kw1">double</font><font class="text"> y = x* dN_col( j, jc ) ;
            </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ic++ )
            {
               leq-&gt;add_to_matrix( x*dN_col( j, ic ), i, j, ic, jc ) ;
               leq-&gt;add_to_matrix( y, i, j, ic, ic) ;
            }
         }
      }
   }

   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;
      </font><font class="kw1">double</font><font class="text"> yy = 2. * c_w / radius / radius ;
      
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=i ; j&lt;nb_nodes ; ++j )
         {
            </font><font class="kw1">double</font><font class="text"> xx = yy * N_row( i ) * N_col( j ) ;
            leq-&gt;add_to_matrix( xx, i, j, 0, 0 ) ;
            </font><font class="kw1">if</font><font class="text">( i != j ) leq-&gt;add_to_matrix( xx, j, i, 0, 0 ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row_vvgrad_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                         </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                         </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                         </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_row_vvgrad_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == fe-&gt;nb_space_dimensions() ) ;
   
   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_row_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_col_nodes = fe-&gt;nb_basis_functions( col ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
   
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
   {
      </font><font class="kw1">double</font><font class="text"> aa_grad = 0. ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         aa_grad += aa(d) * dN_col( j, d ) ;
      }
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
      {
         </font><font class="kw1">double</font><font class="text"> xx = c_w * N_row( i ) * aa_grad ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( xx, i, j, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_grad_row_vv_otimes_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                                 </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                                 </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                                 </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_grad_row_vv_otimes_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() == 
                     fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
  
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> jc=0 ; jc&lt;nbc ; ++jc )
            {
               </font><font class="kw1">double</font><font class="text"> xx = c_w * aa( ic ) * N_col( j ) * dN_row( i, jc ) ;
               leq-&gt;add_to_matrix( xx, i, j, ic, jc ) ;
            }
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_vvgrad_row_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                         </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                         </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                         </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_vvgrad_row_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == fe-&gt;nb_space_dimensions() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_row_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_col_nodes = fe-&gt;nb_basis_functions( col ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> aagrad = 0.0 ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         aagrad +=  aa(d) * dN_row( i, d ) ;
      }
      aagrad *= c_w ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> xx = aagrad * N_col( j ) ;

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( xx, i, j, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_vvgrad_row_vvgrad_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                                </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                                </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                                </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_vvgrad_row_vvgrad_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == fe-&gt;nb_space_dimensions() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> aa_grad = </font><font class="kw3">doubleVector</font><font class="text">( nb_nodes ) ;
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         aa_grad(i) +=  aa(d) * dN_row( i, d ) ;
      }
   }
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> xx = c_w * aa_grad(i) * aa_grad(j) ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( xx, i, j, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_vvgrad_row_lapl_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                              </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                              </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                              </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_vvgrad_row_lapl_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian  ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == fe-&gt;nb_space_dimensions() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_col = fe-&gt;d2Ns_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> aagrad = 0.0 ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         aagrad +=  aa(d) * dN_row( i, d ) ;
      }
      aagrad *= c_w ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> xx = 0.0 ; </font><font class="comment">//??????????????????????? xx ne depend pas de i
</font><font class="text">         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
         {
            xx += d2N_col( j, d, d ) ;
         }
         xx *= aagrad ;

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( xx, i, j, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_vvgrad_row_div_D_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                               </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                               </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                               </font><font class="kw1">double</font><font class="text"> coef,
                               </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dcoef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_vvgrad_row_div_D_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components()==
                     fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() ==
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( dcoef.size() == fe-&gt;nb_space_dimensions() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> w = fe-&gt;weight_of_IP() ;

   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_col = fe-&gt;d2Ns_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> aagrad = 0.0 ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         aagrad +=  aa(d) * dN_row( i, d ) ;
      }
      aagrad *= w ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> divNj = 0.0 ;
         </font><font class="kw1">double</font><font class="text"> gradNjgradmu = 0.0 ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d ) </font><font class="comment">//???????? independence avec i
</font><font class="text">         {
            divNj += d2N_col( j, d, d ) ;
            gradNjgradmu += dN_col( j, d ) * dcoef( d ) ;
         }

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> jc=0 ; jc&lt;nbc ; ++jc )
            {
               </font><font class="kw1">double</font><font class="text"> xx = coef * d2N_col( j, ic, jc )
    		                + dcoef(jc) * dN_col( j, ic ) ;
               </font><font class="kw1">if</font><font class="text">( ic == jc )
               {
                  xx += coef*divNj + gradNjgradmu ;
               }
               xx *= aagrad ;
               leq-&gt;add_to_matrix( xx, i, j, ic, jc ) ;
            }
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_vvgrad_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                     </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                     </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                     </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_vvgrad_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 1 ) ;   
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == fe-&gt;nb_space_dimensions() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> xx = 0.0 ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         xx +=  aa(d) * dN_row( i, d ) ;
      }
      xx *= c_w ;
      leq-&gt;add_to_vector( xx, i ) ;
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_vvgrad_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                     </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                     </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                     </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; coef_1,
                     </font><font class="kw1">double</font><font class="text"> coef_2 )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_vvgrad_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ; 
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( coef_1.size() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> w = coef_2 * fe-&gt;weight_of_IP() ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> yy = 0.0 ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         yy +=  aa(d) * dN_row( i, d ) ;
      }
      yy *= w ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
      {
         </font><font class="kw1">double</font><font class="text"> xx = yy * coef_1( ic ) ;
         leq-&gt;add_to_vector( xx, i, ic ) ;
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row_div_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                      </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                      </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_row_div_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 1 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ==
                  fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;field_calculation_is_handled(
                              fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ),
                              </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() ==
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_row_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_col_nodes = fe-&gt;nb_basis_functions( col ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> jc=0 ; jc&lt;nb_dims ; ++jc )
         {
            </font><font class="kw1">double</font><font class="text"> xx = c_w * N_row( i ) * dN_col( j, jc ) ;
            leq-&gt;add_to_matrix( xx, i, j, 0, jc ) ; 
         }
      }
   }

   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      </font><font class="comment">// Axisymmetrical : div(f) = df/dr+df/dz+f/r
</font><font class="text">      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
      </font><font class="kw1">double</font><font class="text"> yy = c_w / radius ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
         {
            </font><font class="kw1">double</font><font class="text"> xx = yy * N_row( i ) * N_col( j ) ;
            leq-&gt;add_to_matrix( xx, i, j, 0, 0 ) ;
         }
      }
   }
}
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row_grad_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                       </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                       </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_row_grad_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() == 1 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ==
                  fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() ==
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_row_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_col_nodes = fe-&gt;nb_basis_functions( col ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;

   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;

   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
         {
            </font><font class="kw1">double</font><font class="text"> xx = c_w * N_row( i ) * dN_col( j, ic ) ;
            leq-&gt;add_to_matrix( xx, i, j, ic, 0 ) ; 
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_div_row_div_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                          </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                          </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_div_row_div_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 
                     fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ==
                     fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;field_calculation_is_handled(
                              fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ),
                              </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;field_calculation_is_handled(
                              fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ),
                              </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                    fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() ==
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_row_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_col_nodes = fe-&gt;nb_basis_functions( col ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_row = fe-&gt;dNs_at_IP( row ) ;

   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian )
   {
      </font><font class="comment">// Cartesian : div(f) = df/dx+df/dy+df/dz
</font><font class="text">      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
         {
            </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
            {
               </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> jc=0 ; jc&lt;nb_dims ; ++jc )
               {
                  </font><font class="kw1">double</font><font class="text"> xx = dN_row( i, ic ) * dN_col( j, jc ) * c_w ;
                  leq-&gt;add_to_matrix( xx, i, j, ic, jc ) ; 
               }
            }
         }
      }
   }
   </font><font class="kw1">else</font><font class="text"> </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      </font><font class="comment">// Axisymmetrical : div(f) = df/dr+df/dz+f/r
</font><font class="text">      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;
      </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
         {
            </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nb_dims ; ++ic )
            {
               </font><font class="kw1">double</font><font class="text"> divi = dN_row( i, ic ) ;
               </font><font class="kw1">if</font><font class="text">( ic == 0 )
               {
                  divi += N_row( i ) / radius ;
               }
               </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> jc=0 ; jc&lt;nb_dims ; ++jc )
               {
                  </font><font class="kw1">double</font><font class="text"> divj = dN_col( j, jc ) ;
                  </font><font class="kw1">if</font><font class="text">( jc == 0 )
                  {
                     divj += N_col( j ) / radius  ;
                  }
                  </font><font class="kw1">double</font><font class="text"> xx = divi * divj * c_w ;
                  leq-&gt;add_to_matrix( xx, i, j, ic, jc ) ; 
               }
            }
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row_vv_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                     </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                     </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                     </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_row_vv_col&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 1 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() ==
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() ==
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_row_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_col_nodes = fe-&gt;nb_basis_functions( col ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      c_w *= fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
   }
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_col = fe-&gt;Ns_at_IP( col ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_row_nodes ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_col_nodes ; ++j )
      {
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> jc=0 ; jc&lt;nb_dims ; ++jc )
         {
            </font><font class="kw1">double</font><font class="text"> xx = c_w * N_row( i ) * aa( jc ) * N_col( j ) ;
            leq-&gt;add_to_matrix( xx, i, j, 0, jc ) ; 
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_lapl_row_vvgrad_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                              </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                              </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; aa,
                              </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE::add_lapl_row_vvgrad_col &quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( aa.size() == fe-&gt;nb_space_dimensions() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
 
   </font><font class="kw3">doubleArray2D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; dN_col = fe-&gt;dNs_at_IP( col ) ;
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_row = fe-&gt;d2Ns_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> xx = 0.0 ;  </font><font class="comment">//??????????????????????? xx ne depend pas de i
</font><font class="text">      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         xx +=  d2N_row( i, d, d ) ;
      }
      xx *= c_w  ; 
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> aagrad = 0.0 ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
         {
            aagrad +=  aa( d ) * dN_col( j, d ) ;
         }
         aagrad *= xx ;	 

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( aagrad, i, j, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_row_lapl_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                       </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                       </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE::add_row_lapl_col &quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                     fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
  
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_col = fe-&gt;d2Ns_at_IP( col ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> xx = 0.0 ; 
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         xx += d2N_col( i, d, d ) ;
      }
      xx *= c_w ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> yy = xx * N_row( j )  ; 

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( yy, j, i, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_lapl_row_lapl_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                            </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                            </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE::add_lapl_row_lapl_col &quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
   
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_col = fe-&gt;d2Ns_at_IP( col ) ;
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_row = fe-&gt;d2Ns_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> xx = 0.0 ; 
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         xx += d2N_row( i, d, d ) ;
      }
      xx *= c_w ;
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> yy = 0. ; 
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
         {
            yy += d2N_col( j, d, d ) ;
         }
         yy *= xx ;
         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( yy, j, i, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_lapl_row_col( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                       </font><font class="kw3">PDE_LocalFEcell</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                       </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE::add_lapl_row_col &quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_columns() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_column_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
  
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_col = fe-&gt;d2Ns_at_IP( col ) ;
   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; N_row = fe-&gt;Ns_at_IP( row ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> xx = 0.0 ; 
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         xx += d2N_col( i, d, d ) ;
      }
      xx *= c_w  ; 
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_nodes ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> yy = N_row( j ) * xx ;	 

         </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
         {
            leq-&gt;add_to_matrix( yy, j, i, ic, ic ) ;
         }
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_lapl_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                   </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                   </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_lapl_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() == 1 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw1">double</font><font class="text"> c_w = fe-&gt;weight_of_IP() * coef ;
 
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_col = fe-&gt;d2Ns_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; i++ )
   {
      </font><font class="kw1">double</font><font class="text"> xx = 0.0 ; 
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         xx += d2N_col( i, d, d ) ;
      }
      xx *= c_w  ; 
      leq-&gt;add_to_vector( xx, i ) ;
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_lapl_row( </font><font class="kw3">PDE_LocalEquation</font><font class="text">* leq,
                   </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                   </font><font class="kw3">doubleVector</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; coef_1,
                   </font><font class="kw1">double</font><font class="text"> coef_2 )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_lapl_row&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled(
                     fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::col ), </font><font class="kw3">PDE_LocalFE</font><font class="text">::d2N ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_rows() == 
                  fe-&gt;nb_basis_functions( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( leq-&gt;nb_row_sub_indices() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( coef_1.size() == 
                  fe-&gt;field( </font><font class="kw3">PDE_LocalFE</font><font class="text">::row )-&gt;nb_components() ) ;

   </font><font class="kw2">size_t</font><font class="text"> nbc = fe-&gt;field( row )-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;
   </font><font class="kw2">size_t</font><font class="text"> nb_nodes = fe-&gt;nb_basis_functions( row ) ;
   </font><font class="kw1">double</font><font class="text"> w = coef_2 * fe-&gt;weight_of_IP() ;
   
   </font><font class="kw3">doubleArray3D</font><font class="text"> </font><font class="kw1">const</font><font class="text">&amp; d2N_col = fe-&gt;d2Ns_at_IP( col ) ;

   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_nodes ; ++i )
   {
      </font><font class="kw1">double</font><font class="text"> yy = 0.0 ; 
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> d=0 ; d&lt;nb_dims ; ++d )
      {
         yy += d2N_col( i, d, d ) ;
      }
      yy *= w  ; 

      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> ic=0 ; ic&lt;nbc ; ++ic )
      {
         </font><font class="kw1">double</font><font class="text"> xx = yy * coef_1( ic ) ;
         leq-&gt;add_to_vector( xx, i, ic ) ;
      }
   }
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_D_u_D_u_at_IP( </font><font class="kw1">double</font><font class="text">&amp; target,
                        </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* u,
                        </font><font class="kw2">size_t</font><font class="text"> u_level,
                        </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                        </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_D_u_D_u_at_IP&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u-&gt;nb_components() == fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u-&gt;storage_depth() &gt; u_level ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled( u, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">(
                     </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                     fe-&gt;field_calculation_is_handled(
                        u, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;

   </font><font class="kw2">size_t</font><font class="text"> </font><font class="kw1">const</font><font class="text"> nb_comps = u-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> </font><font class="kw1">const</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;

   </font><font class="kw3">doubleArray2D</font><font class="text"> grad( nb_comps, nb_dims ) ;
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_dims ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_comps ; ++j )
      {
         grad(i,j) = fe-&gt;gradient_at_IP( u, u_level, i, j ) ;
      }
   }

   </font><font class="kw1">double</font><font class="text"> xx = 0. ;
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_dims ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=i+1 ; j&lt;nb_comps ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> dij = grad(i,j)+grad(j,i) ;
         xx += 2.*dij*dij ;
      }
      </font><font class="kw1">double</font><font class="text"> dii = 2.*grad(i,i) ;
      xx += dii*dii ;
   }
   
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
      </font><font class="kw1">double</font><font class="text"> dii = 2.*fe-&gt;value_at_IP( u, u_level, 0 )/radius ;
      xx += dii*dii ;
   }

   target += coef*xx ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_D_u_D_u_at_pt( </font><font class="kw1">double</font><font class="text">&amp; target,
                        </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* u,
                        </font><font class="kw2">size_t</font><font class="text"> u_level,
                        </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                        </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_D_u_D_u_at_pt&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;calculation_point() != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;calculation_point()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u-&gt;nb_components() == fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u-&gt;storage_depth() &gt; u_level ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled( u, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">(
                     </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                     fe-&gt;field_calculation_is_handled(
                        u, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;

   </font><font class="kw2">size_t</font><font class="text"> </font><font class="kw1">const</font><font class="text"> nb_comps = u-&gt;nb_components() ;
   </font><font class="kw2">size_t</font><font class="text"> </font><font class="kw1">const</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;

   </font><font class="kw3">doubleArray2D</font><font class="text"> grad( nb_comps, nb_dims ) ;
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_dims ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=0 ; j&lt;nb_comps ; ++j )
      {
         grad(i,j) = fe-&gt;gradient_at_pt( u, u_level, i, j ) ;
      }
   }

   </font><font class="kw1">double</font><font class="text"> xx = 0. ;
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_dims ; ++i )
   {
      </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> j=i+1 ; j&lt;nb_comps ; ++j )
      {
         </font><font class="kw1">double</font><font class="text"> dij = grad(i,j)+grad(j,i) ;
         xx += 2.*dij*dij ;
      }
      </font><font class="kw1">double</font><font class="text"> dii = 2.*grad(i,i) ;
      xx += dii*dii ;
   }
   
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;calculation_point()-&gt;coordinate(0) ;
      </font><font class="kw1">double</font><font class="text"> dii = 2.*fe-&gt;value_at_pt( u, u_level, 0 )/radius ;
      xx += dii*dii ;
   }

   target += coef*xx ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_div_u_at_IP( </font><font class="kw1">double</font><font class="text">&amp; target,
                      </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* u,
                      </font><font class="kw2">size_t</font><font class="text"> u_level,
                      </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                      </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_div_u_at_IP&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;valid_IP() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;coordinates_of_IP()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u-&gt;nb_components() == fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u-&gt;storage_depth() &gt; u_level ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled( u, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">(
                     </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                     fe-&gt;field_calculation_is_handled(
                        u, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;

   </font><font class="kw2">size_t</font><font class="text"> </font><font class="kw1">const</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;

   </font><font class="kw1">double</font><font class="text"> xx = 0. ;
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_dims ; ++i )
   {
      xx += fe-&gt;gradient_at_IP( u, u_level, i, i ) ;
   }
   
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;coordinates_of_IP()-&gt;coordinate(0) ;
      xx += fe-&gt;value_at_IP( u, u_level, 0 )/radius ;
   }

   target += coef*xx ;
}

</font><font class="comment">//----------------------------------------------------------------------
</font><font class="kw1">void
</font><font class="kw3">FE</font><font class="text">:: add_div_u_at_pt( </font><font class="kw1">double</font><font class="text">&amp; target,
                      </font><font class="kw3">PDE_DiscreteField</font><font class="text"> </font><font class="kw1">const</font><font class="text">* u,
                      </font><font class="kw2">size_t</font><font class="text"> u_level,
                      </font><font class="kw3">PDE_LocalFE</font><font class="text"> </font><font class="kw1">const</font><font class="text">* fe,
                      </font><font class="kw1">double</font><font class="text"> coef )
</font><font class="comment">//----------------------------------------------------------------------
</font><font class="text">{
   </font><font class="kw3">PEL_LABEL</font><font class="text">( </font><font class="string">&quot;FE:: add_div_u_at_pt&quot;</font><font class="text"> ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::cartesian ||
                  </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;is_valid() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;calculation_point() != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;nb_space_dimensions() == 2 ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                           fe-&gt;calculation_point()-&gt;coordinate(0) &gt;= 0. ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u != 0 ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u-&gt;nb_components() == fe-&gt;nb_space_dimensions() ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( u-&gt;storage_depth() &gt; u_level ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( fe-&gt;field_calculation_is_handled( u, </font><font class="kw3">PDE_LocalFE</font><font class="text">::dN ) ) ;
   </font><font class="kw3">PEL_CHECK_PRE</font><font class="text">( </font><font class="kw3">IMPLIES</font><font class="text">(
                     </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical,
                     fe-&gt;field_calculation_is_handled(
                        u, </font><font class="kw3">PDE_LocalFE</font><font class="text">::N ) ) ) ;

   </font><font class="kw2">size_t</font><font class="text"> </font><font class="kw1">const</font><font class="text"> nb_dims = fe-&gt;nb_space_dimensions() ;

   </font><font class="kw1">double</font><font class="text"> xx = 0. ;
   </font><font class="kw1">for</font><font class="text">( </font><font class="kw2">size_t</font><font class="text"> i=0 ; i&lt;nb_dims ; ++i )
   {
      xx += fe-&gt;gradient_at_pt( u, u_level, i, i ) ;
   }
   
   </font><font class="kw1">if</font><font class="text">( </font><font class="kw3">FE</font><font class="text">::geometry() == </font><font class="kw3">FE</font><font class="text">::axisymmetrical )
   {
      </font><font class="kw1">double</font><font class="text"> radius = fe-&gt;calculation_point()-&gt;coordinate(0) ;
      xx += fe-&gt;value_at_pt( u, u_level, 0 )/radius ;
   }

   target += coef*xx ;
}

</font>
</pre>
</body>
</html>
